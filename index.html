<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cha-Gye-Bu | 차량 관리 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#09090b', // Zinc 950
                            800: '#18181b', // Zinc 900
                            700: '#27272a', // Zinc 800
                            600: '#3f3f46', // Zinc 700
                            border: '#27272a'
                        },
                        brand: {
                            DEFAULT: '#6366f1', // Indigo 500
                            hover: '#4f46e5',   // Indigo 600
                            bg: 'rgba(99, 102, 241, 0.1)'
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for Dark Mode */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        /* Glassmorphism utilities */
        .glass {
            background: rgba(24, 24, 27, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-dark-900 text-gray-200 font-sans antialiased min-h-screen selection:bg-brand selection:text-white overflow-x-hidden"
      x-data="app()">

    <!-- Background Gradients -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-brand/20 blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-purple-900/20 blur-[120px]"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-5xl mx-auto px-4 py-8 h-screen flex flex-col">
        
        <!-- Header (Visible only after onboarding) -->
        <header x-show="router.current !== 'onboarding'" x-transition 
                class="flex justify-between items-center mb-8 pb-4 border-b border-dark-border">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-brand flex items-center justify-center text-white font-bold">
                    <i data-lucide="car-front"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">Cha-Gye-Bu</h1>
            </div>
            
            <div class="flex gap-2">
                <!-- DB Settings Dropdown -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open" class="p-2 rounded-md hover:bg-dark-700 text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    
                    <div x-show="open" @click.outside="open = false" 
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         class="absolute right-0 mt-2 w-48 bg-dark-800 border border-dark-600 rounded-lg shadow-xl py-1 z-50">
                        <button @click="exportDB(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-300 hover:bg-dark-700 text-left">
                            <i data-lucide="download" class="w-4 h-4"></i> 내보내기 (JSON)
                        </button>
                        <button @click="triggerImport(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-300 hover:bg-dark-700 text-left">
                            <i data-lucide="upload" class="w-4 h-4"></i> 가져오기
                        </button>
                        <div class="h-px bg-dark-600 my-1"></div>
                        <button @click="closeDatabase(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-red-400 hover:bg-dark-700 text-left">
                            <i data-lucide="log-out" class="w-4 h-4"></i> 데이터베이스 닫기
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- View: Onboarding -->
        <main x-show="router.current === 'onboarding'" 
              x-transition:enter="transition ease-out duration-300 delay-100"
              x-transition:enter-start="opacity-0 translate-y-4"
              x-transition:enter-end="opacity-100 translate-y-0"
              class="flex-1 flex flex-col justify-center items-center text-center">
            
            <div class="mb-8 relative">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand to-purple-600 flex items-center justify-center shadow-lg shadow-brand/20">
                    <i data-lucide="database" class="w-10 h-10 text-white"></i>
                </div>
            </div>
            
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 tracking-tight">
                차계부 관리의 시작
            </h1>
            <p class="text-gray-400 max-w-md mb-12 text-lg">
                안전하게 내 차의 모든 기록을 관리하세요.<br>
                데이터는 브라우저에 저장되거나 클라우드와 연동됩니다.
            </p>

            <div class="grid md:grid-cols-2 gap-4 w-full max-w-2xl">
                <!-- Create New -->
                <button @click="createLocalDatabase()" 
                        class="group p-6 rounded-xl border border-dark-600 bg-dark-800 hover:bg-dark-700 hover:border-brand transition-all duration-300 text-left relative overflow-hidden">
                    <div class="absolute inset-0 bg-brand/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-white">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">새 데이터베이스 만들기</h3>
                    <p class="text-sm text-gray-400">로컬 저장소에 새로운 차계부를 생성합니다. 빠르고 간편합니다.</p>
                </button>

                <!-- Open Existing (Simulated WebDAV/File) -->
                <button @click="openModal('webdav-config')"
                        class="group p-6 rounded-xl border border-dark-600 bg-dark-800 hover:bg-dark-700 hover:border-gray-500 transition-all duration-300 text-left">
                    <div class="w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-white">
                        <i data-lucide="globe" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">WebDAV 연결하기</h3>
                    <p class="text-sm text-gray-400">개인 NAS나 클라우드 저장소에 있는 차계부 파일을 불러옵니다.</p>
                </button>
            </div>
            
            <div class="mt-8 text-sm text-gray-500">
                <button @click="triggerImport()" class="hover:text-gray-300 underline underline-offset-4">
                    이미 백업 파일(.json)이 있으신가요?
                </button>
            </div>
        </main>

        <!-- View: Car Selection -->
        <main x-show="router.current === 'car-list'" 
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100"
              class="flex-1">
            
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white">나의 차량</h2>
                    <p class="text-gray-400 text-sm mt-1">관리할 차량을 선택하거나 추가하세요.</p>
                </div>
                <button @click="openModal('add-car')" 
                        class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-md font-medium text-sm flex items-center gap-2 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i> 차량 추가
                </button>
            </div>

            <!-- Car Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="car in db.cars" :key="car.id">
                    <div @click="selectCar(car.id)" 
                         class="group relative bg-dark-800 border border-dark-600 rounded-xl p-5 cursor-pointer hover:border-brand/50 hover:bg-dark-800/80 transition-all duration-200 overflow-hidden">
                        
                        <!-- Decorative gradient on hover -->
                        <div class="absolute inset-0 bg-gradient-to-r from-brand/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-dark-700 text-gray-300 border border-dark-600" x-text="car.fuelType"></span>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 group-hover:text-white transition-colors"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white tracking-tight" x-text="car.number"></h3>
                                <p class="text-gray-400 text-sm" x-text="car.model"></p>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t border-dark-700 flex justify-between text-xs text-gray-500">
                                <span x-text="car.year + '년식'"></span>
                                <span x-text="formatDistance(car.totalDistance)"></span>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <template x-if="db.cars.length === 0">
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500 border border-dashed border-dark-600 rounded-xl bg-dark-800/30">
                        <i data-lucide="car" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p class="text-lg font-medium">등록된 차량이 없습니다.</p>
                        <p class="text-sm mt-1">우측 상단의 버튼을 눌러 첫 차량을 등록해보세요.</p>
                    </div>
                </template>
            </div>
        </main>
    </div>

    <!-- Hidden Input for File Import -->
    <input type="file" id="fileInput" accept=".json" class="hidden" @change="handleFileImport($event)">

    <!-- Modals -->
    <div x-show="modal.active" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <!-- Backdrop -->
        <div x-show="modal.active" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="closeModal()"
             class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Content -->
        <div x-show="modal.active"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
             class="relative w-full max-w-md bg-dark-800 border border-dark-600 rounded-xl shadow-2xl overflow-hidden">
            
            <!-- Modal: Add Car -->
            <div x-show="modal.type === 'add-car'" class="p-6">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-white">차량 추가</h3>
                    <button @click="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <form @submit.prevent="submitAddCar" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">차량 번호</label>
                        <input type="text" x-model="forms.car.number" required placeholder="예: 12가 3456" 
                               class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand placeholder-gray-600">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">제조사 및 차종</label>
                        <input type="text" x-model="forms.car.model" required placeholder="예: 현대 쏘나타" 
                               class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand placeholder-gray-600">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">연식 (YYYY)</label>
                            <input type="number" x-model="forms.car.year" required placeholder="2024" 
                                   class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand placeholder-gray-600">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">연료</label>
                            <select x-model="forms.car.fuelType" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                                <option value="휘발유">휘발유</option>
                                <option value="경유">경유</option>
                                <option value="LPG">LPG</option>
                                <option value="전기">전기</option>
                                <option value="하이브리드">하이브리드</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">현재 주행거리 (km)</label>
                        <input type="number" x-model="forms.car.totalDistance" placeholder="0" 
                               class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand placeholder-gray-600">
                    </div>

                    <div class="pt-4 flex justify-end gap-2">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-dark-700">취소</button>
                        <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium bg-white text-black hover:bg-gray-200">저장</button>
                    </div>
                </form>
            </div>

            <!-- Modal: WebDAV Config -->
            <div x-show="modal.type === 'webdav-config'" class="p-6">
                 <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-white">WebDAV 연결</h3>
                    <button @click="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="p-3 bg-brand/10 border border-brand/20 rounded-md text-brand text-xs">
                        <i data-lucide="info" class="inline w-3 h-3 mr-1"></i> 현재 버전에서는 UI 시뮬레이션만 제공됩니다.
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">서버 주소</label>
                        <input type="text" placeholder="https://dav.example.com" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">아이디</label>
                            <input type="text" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">비밀번호</label>
                            <input type="password" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                    </div>
                    <div class="pt-4 flex justify-end gap-2">
                         <button type="button" @click="closeModal()" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-dark-700">취소</button>
                         <button type="button" @click="connectWebDAVSim()" class="px-4 py-2 rounded-md text-sm font-medium bg-brand hover:bg-brand-hover text-white">연결</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 translate-y-2"
                 class="px-4 py-2.5 rounded-full shadow-lg border text-sm font-medium flex items-center gap-2 pointer-events-auto"
                 :class="{
                    'bg-dark-800 border-brand text-white': toast.type === 'success',
                    'bg-red-900/90 border-red-700 text-white': toast.type === 'error',
                    'bg-dark-700 border-dark-600 text-gray-200': toast.type === 'info'
                 }">
                <i x-show="toast.type === 'success'" data-lucide="check-circle" class="w-4 h-4 text-brand"></i>
                <i x-show="toast.type === 'error'" data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script>
        // --- Backend Abstraction Layer ---
        const Backend = {
            DB_KEY: 'chagyebu_db',
            
            // 데이터베이스 로드
            load() {
                const raw = localStorage.getItem(this.DB_KEY);
                if (raw) {
                    try {
                        return JSON.parse(raw);
                    } catch (e) {
                        console.error('DB parse error', e);
                        return null;
                    }
                }
                return null;
            },

            // 데이터베이스 저장
            save(data) {
                // LocalStorage 저장
                localStorage.setItem(this.DB_KEY, JSON.stringify(data));
                
                // WebDAV 로직이 있다면 여기서 실행 (추후 구현)
                // if (data.config.type === 'webdav') { ... }
                
                return true;
            },

            // 초기화
            initNew() {
                const initialData = {
                    config: { type: 'local', lastSync: null },
                    cars: [],
                    records: []
                };
                this.save(initialData);
                return initialData;
            },

            // 삭제 (로그아웃)
            clear() {
                // 실제 데이터를 삭제하지 않고 메모리에서만 언로드하는 개념이지만,
                // LocalStorage 모드이므로 사용자가 원하면 유지하거나 삭제할 수 있음.
                // 여기서는 현재 세션 상태만 초기화함.
                return true; 
            }
        };

        // --- Alpine App Logic ---
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                router: {
                    current: 'onboarding' // onboarding | car-list | car-detail (추후)
                },
                db: null, // Loaded Data
                
                // UI States
                modal: {
                    active: false,
                    type: null // 'add-car' | 'webdav-config'
                },
                forms: {
                    car: { number: '', model: '', year: '', fuelType: '휘발유', totalDistance: '' }
                },
                toasts: [],

                init() {
                    // Lucide Icons Render
                    this.$watch('router.current', () => {
                        this.$nextTick(() => lucide.createIcons());
                    });
                    this.$watch('modal.active', (val) => {
                        if(val) this.$nextTick(() => lucide.createIcons());
                    });

                    // Check for existing DB
                    const existingData = Backend.load();
                    if (existingData) {
                        this.db = existingData;
                        this.router.current = 'car-list';
                        this.showToast('데이터베이스를 불러왔습니다.', 'success');
                    }
                    
                    lucide.createIcons();
                },

                // --- Actions ---

                createLocalDatabase() {
                    this.db = Backend.initNew();
                    this.router.current = 'car-list';
                    this.showToast('새 로컬 데이터베이스가 생성되었습니다.', 'success');
                },

                openModal(type) {
                    this.modal.type = type;
                    this.modal.active = true;
                    // Reset forms
                    if (type === 'add-car') {
                        this.forms.car = { number: '', model: '', year: new Date().getFullYear(), fuelType: '휘발유', totalDistance: '' };
                    }
                },

                closeModal() {
                    this.modal.active = false;
                    setTimeout(() => { this.modal.type = null; }, 200);
                },

                submitAddCar() {
                    const newCar = {
                        id: crypto.randomUUID(),
                        ...this.forms.car,
                        totalDistance: Number(this.forms.car.totalDistance) || 0,
                        createdAt: new Date().toISOString()
                    };

                    this.db.cars.push(newCar);
                    this.autoSave();
                    
                    this.closeModal();
                    this.showToast('차량이 추가되었습니다.', 'success');
                },

                selectCar(carId) {
                    // 추후 구현: 상세 페이지 이동
                    this.showToast(`차량 선택됨: ${carId} (상세화면 준비중)`, 'info');
                },

                connectWebDAVSim() {
                    this.closeModal();
                    this.showToast('WebDAV 연결 시뮬레이션: 성공', 'success');
                    // 실제로는 여기서 WebDAV 설정 저장 및 데이터 pull
                    if (!this.db) {
                        this.db = Backend.initNew();
                        this.db.config.type = 'webdav';
                    }
                    this.router.current = 'car-list';
                },

                closeDatabase() {
                    // 현재 메모리의 DB를 비우고 온보딩으로 이동
                    this.db = null;
                    this.router.current = 'onboarding';
                    this.showToast('데이터베이스를 닫았습니다.', 'info');
                },

                // --- Data Management ---

                autoSave() {
                    if (this.db) {
                        Backend.save(this.db);
                        // WebDAV인 경우 미저장 상태 표시 로직 추가 가능
                    }
                },

                exportDB() {
                    if (!this.db) return;
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.db));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "chagyebu_backup_" + new Date().toISOString().slice(0,10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    this.showToast('백업 파일이 다운로드되었습니다.', 'success');
                },

                triggerImport() {
                    document.getElementById('fileInput').click();
                },

                handleFileImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            // Basic validation
                            if (data.cars && Array.isArray(data.cars)) {
                                this.db = data;
                                Backend.save(this.db); // Save to local immediately
                                this.router.current = 'car-list';
                                this.showToast('데이터베이스를 가져왔습니다.', 'success');
                            } else {
                                throw new Error('Invalid format');
                            }
                        } catch (err) {
                            this.showToast('올바르지 않은 차계부 파일입니다.', 'error');
                        }
                    };
                    reader.readAsText(file);
                    // Reset input
                    event.target.value = '';
                },

                // --- Utilities ---

                showToast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type, visible: true });
                    setTimeout(() => {
                        const index = this.toasts.findIndex(t => t.id === id);
                        if (index > -1) this.toasts[index].visible = false;
                    }, 3000);
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 3300);
                },

                formatDistance(km) {
                    return new Intl.NumberFormat('ko-KR').format(km) + ' km';
                }
            }));
        });

        Alpine.start();
    </script>
</body>
</html>
