<!doctype html>
<html lang="ko" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehlog</title>

    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4.1.18"></script>
    <style type="text/tailwindcss">
      @theme {
        --color-border: hsl(var(--border));
        --color-input: hsl(var(--input));
        --color-ring: hsl(var(--ring));
        --color-background: hsl(var(--background));
        --color-foreground: hsl(var(--foreground));

        --color-primary: hsl(var(--primary));
        --color-primary-foreground: hsl(var(--primary-foreground));
        --color-secondary: hsl(var(--secondary));
        --color-secondary-foreground: hsl(var(--secondary-foreground));
        --color-muted: hsl(var(--muted));
        --color-muted-foreground: hsl(var(--muted-foreground));
        --color-accent: hsl(var(--accent));
        --color-accent-foreground: hsl(var(--accent-foreground));
        --color-popover: hsl(var(--popover));
        --color-popover-foreground: hsl(var(--popover-foreground));
        --color-destructive: hsl(var(--destructive));
        --color-destructive-foreground: hsl(var(--destructive-foreground));

        --color-dark-950: #09090b;
        --color-dark-900: #18181b;
        --color-dark-800: #27272a;
        --color-dark-700: #3f3f46;

        --color-brand: #6366f1;
        --color-brand-hover: #4f46e5;

        --radius-lg: var(--radius);
        --radius-md: calc(var(--radius) - 2px);
        --radius-sm: calc(var(--radius) - 4px);

        --font-sans: "Pretendard", "-apple-system", "BlinkMacSystemFont", "system-ui", "Roboto", "sans-serif";
      }
    </style>
    <style>
      :root {
        --background: 240 10% 3.9%;
        --foreground: 0 0% 98%;
        --card: 240 10% 3.9%;
        --card-foreground: 0 0% 98%;
        --popover: 240 10% 3.9%;
        --popover-foreground: 0 0% 98%;
        --primary: 0 0% 98%;
        --primary-foreground: 240 5.9% 10%;
        --secondary: 240 3.7% 15.9%;
        --secondary-foreground: 0 0% 98%;
        --muted: 240 3.7% 15.9%;
        --muted-foreground: 240 5% 64.9%;
        --accent: 240 3.7% 15.9%;
        --accent-foreground: 0 0% 98%;
        --destructive: 0 62.8% 30.6%;
        --destructive-foreground: 0 0% 98%;
        --border: 240 3.7% 15.9%;
        --input: 240 3.7% 15.9%;
        --ring: 240 4.9% 83.9%;
        --radius: 0.5rem;
      }

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #3f3f46;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #52525b;
      }

      input[type='number']::-webkit-inner-spin-button,
      input[type='number']::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      [x-cloak] {
        display: none !important;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.8/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.563.0/dist/umd/lucide.min.js"></script>
  </head>
  <body
    class="bg-background text-foreground selection:bg-brand min-h-screen overflow-x-hidden font-sans
      antialiased selection:text-white"
    x-data="app()"
    x-cloak
  >
    <div class="pointer-events-none fixed inset-0 z-0">
      <div
        class="bg-brand/10 absolute top-[-10%] left-[-10%] h-[40%] w-[40%] rounded-full
          blur-[120px]"
      ></div>
      <div
        class="absolute right-[-10%] bottom-[-10%] h-[40%] w-[40%] rounded-full bg-purple-900/10
          blur-[120px]"
      ></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 mx-auto flex h-screen max-w-5xl flex-col px-4 py-6">
      <!-- Header -->
      <header
        x-show="router.current !== 'onboarding'"
        class="border-border mb-6 flex h-16 shrink-0 items-center justify-between border-b pb-4
          transition-all duration-300"
      >
        <div class="flex items-center gap-3">
          <template x-if="router.current === 'car-list'">
            <div
              class="animate-in fade-in slide-in-from-left-2 flex items-center gap-3 duration-300"
            >
              <div
                class="bg-brand shadow-brand/20 flex h-9 w-9 items-center justify-center rounded-lg
                  font-bold text-white shadow-lg"
              >
                <i x-lucide="car-front" class="h-5 w-5"></i>
              </div>
              <h1 class="text-xl font-bold tracking-tight">Vehlog</h1>
            </div>
          </template>
          <template x-if="router.current === 'car-detail'">
            <div
              class="animate-in fade-in slide-in-from-left-2 flex items-center gap-3 duration-300"
            >
              <button
                @click="router.current = 'car-list'"
                class="hover:bg-accent hover:border-border flex h-9 w-9 items-center justify-center
                  rounded-md border border-transparent transition-colors"
              >
                <i x-lucide="arrow-left" class="h-5 w-5"></i>
              </button>
              <div>
                <h2 class="text-lg leading-none font-bold" x-text="activeCar?.number"></h2>
                <p class="text-muted-foreground mt-1 text-xs" x-text="activeCar?.model"></p>
              </div>
            </div>
          </template>
        </div>

        <div class="flex gap-2">
          <div x-data="({ open: false })" class="relative">
            <button
              @click="open = !open"
              class="hover:bg-accent text-muted-foreground hover:text-foreground flex h-9 w-9
                items-center justify-center rounded-md transition-colors"
            >
              <i x-lucide="settings" class="h-5 w-5"></i>
            </button>
            <div
              x-show="open"
              @click.outside="open = false"
              x-transition:enter="transition ease-out duration-100"
              x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100"
              class="bg-popover border-border absolute right-0 z-50 mt-2 w-48 rounded-lg border py-1
                shadow-xl"
            >
              <button
                @click="exportDB(); open = false"
                class="hover:bg-accent flex w-full items-center gap-2 px-4 py-2 text-left text-sm"
              >
                <i x-lucide="download" class="h-4 w-4"></i> 내보내기 (JSON)
              </button>
              <button
                @click="triggerImport(); open = false"
                class="hover:bg-accent flex w-full items-center gap-2 px-4 py-2 text-left text-sm"
              >
                <i x-lucide="upload" class="h-4 w-4"></i> 가져오기
              </button>
              <div class="bg-border my-1 h-px"></div>
              <button
                @click="closeDatabase(); open = false"
                class="hover:bg-accent flex w-full items-center gap-2 px-4 py-2 text-left text-sm
                  text-red-400"
              >
                <i x-lucide="log-out" class="h-4 w-4"></i> 데이터베이스 닫기
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- View: Onboarding -->
      <main
        x-show="router.current === 'onboarding'"
        x-transition:enter="transition ease-out duration-300"
        class="flex flex-1 flex-col items-center justify-center pb-20 text-center"
      >
        <div class="relative mb-8">
          <div
            class="from-brand shadow-brand/20 flex h-20 w-20 items-center justify-center rounded-2xl
              bg-gradient-to-br to-purple-600 shadow-2xl"
          >
            <i x-lucide="database" class="h-10 w-10 text-white"></i>
          </div>
        </div>
        <h1 class="mb-4 text-4xl font-bold tracking-tight md:text-5xl">차계부 관리의 시작</h1>
        <p class="text-muted-foreground mb-12 max-w-md text-lg">
          안전하게 내 차의 모든 기록을 관리하세요.<br />데이터는 브라우저에 저장되거나 클라우드와
          연동됩니다.
        </p>
        <div class="grid w-full max-w-2xl gap-4 md:grid-cols-2">
          <button
            @click="createLocalDatabase()"
            class="group border-border bg-card hover:bg-accent relative overflow-hidden rounded-xl
              border p-6 text-left transition-all duration-300"
          >
            <div
              class="bg-secondary mb-4 flex h-10 w-10 items-center justify-center rounded-full
                transition-transform group-hover:scale-110"
            >
              <i x-lucide="plus" class="h-5 w-5"></i>
            </div>
            <h3 class="mb-1 text-lg font-semibold">새 데이터베이스 만들기</h3>
            <p class="text-muted-foreground text-sm">로컬 저장소에 새로운 차계부를 생성합니다.</p>
          </button>
          <button
            @click="openModal('webdav-config')"
            class="group border-border bg-card hover:bg-accent rounded-xl border p-6 text-left
              transition-all duration-300"
          >
            <div
              class="bg-secondary mb-4 flex h-10 w-10 items-center justify-center rounded-full
                transition-transform group-hover:scale-110"
            >
              <i x-lucide="globe" class="h-5 w-5"></i>
            </div>
            <h3 class="mb-1 text-lg font-semibold">WebDAV 연결하기</h3>
            <p class="text-muted-foreground text-sm">기존 데이터를 불러옵니다.</p>
          </button>
        </div>
      </main>

      <!-- View: Car Selection (List) -->
      <main
        x-show="router.current === 'car-list'"
        x-transition:enter="transition ease-out duration-300"
        class="flex-1"
      >
        <!-- (Car List Content preserved) -->
        <div class="mb-6 flex items-end justify-between">
          <div>
            <h2 class="text-2xl font-bold">나의 차량</h2>
            <p class="text-muted-foreground mt-1 text-sm">관리할 차량을 선택하거나 추가하세요.</p>
          </div>
          <button
            @click="openModal('add-car')"
            class="focus-visible:ring-ring bg-primary text-primary-foreground hover:bg-primary/90
              inline-flex h-10 items-center justify-center rounded-md px-4 py-2 text-sm font-medium
              shadow-xs transition-colors focus-visible:ring-1 focus-visible:outline-none"
          >
            <i x-lucide="plus" class="mr-2 h-4 w-4"></i> 차량 추가
          </button>
        </div>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
          <template x-for="car in db?.cars" :key="car.id">
            <div
              @click="selectCar(car.id)"
              class="group bg-card border-border hover:border-brand/50 hover:bg-accent/50 relative
                cursor-pointer rounded-xl border p-5 transition-all duration-200"
            >
              <div class="relative z-10 flex h-full flex-col justify-between">
                <div>
                  <div class="mb-2 flex items-start justify-between">
                    <span
                      class="border-border text-foreground inline-flex items-center rounded-md
                        border px-2.5 py-0.5 text-xs font-semibold transition-colors"
                      x-text="car.fuelType"
                    >
                    </span>
                    <i
                      x-lucide="chevron-right"
                      class="text-muted-foreground group-hover:text-foreground h-4 w-4
                        transition-colors"
                    >
                    </i>
                  </div>
                  <h3 class="text-xl font-bold tracking-tight" x-text="car.number"></h3>
                  <p class="text-muted-foreground text-sm" x-text="car.maker + ' ' + car.model"></p>
                </div>
                <div
                  class="border-border text-muted-foreground mt-6 flex justify-between border-t pt-4
                    text-xs"
                >
                  <span x-text="car.year + '년식'"></span>
                  <span x-text="formatDistance(car.totalDistance)"></span>
                </div>
              </div>
            </div>
          </template>
          <template x-if="!db?.cars.length">
            <div
              class="text-muted-foreground border-border bg-card/50 col-span-full flex flex-col
                items-center justify-center rounded-xl border border-dashed py-20"
            >
              <i x-lucide="car" class="mb-4 h-12 w-12 opacity-50"></i>
              <p class="text-lg font-medium">등록된 차량이 없습니다.</p>
            </div>
          </template>
        </div>
      </main>

      <!-- View: Car Detail -->
      <main
        x-show="router.current === 'car-detail'"
        class="flex h-full flex-1 flex-col overflow-hidden"
      >
        <!-- Tabs -->
        <div class="border-border mb-6 flex w-full items-center border-b">
          <template x-for="tab in ['info', 'refuel', 'maintenance', 'etc']">
            <button
              @click="detail.tab = tab"
              class="hover:text-foreground relative px-4 py-2.5 text-sm font-medium
                transition-colors"
              :class="detail.tab === tab ? 'text-brand' : 'text-muted-foreground'"
            >
              <span
                x-text="({ info: '정보', refuel: '주유', maintenance: '정비', etc: '기타' })[tab]"
              >
              </span>
              <div
                x-show="detail.tab === tab"
                class="bg-brand absolute right-0 bottom-0 left-0 h-0.5"
                x-transition
              ></div>
            </button>
          </template>
        </div>

        <!-- Content Area -->
        <div class="relative flex flex-1 flex-col overflow-hidden">
          <!-- Tab: Info -->
          <div
            x-show="detail.tab === 'info'"
            class="animate-in fade-in zoom-in-95 flex-1 overflow-y-auto pb-20 duration-200"
          >
            <div class="bg-card border-border rounded-xl border p-6">
              <!-- Info Header & Form (Preserved) -->
              <div class="mb-6 flex items-center justify-between">
                <h3 class="flex items-center gap-2 text-lg font-bold">
                  <i x-lucide="info" class="text-brand h-4 w-4"></i> 기본 정보
                </h3>
                <button
                  @click="toggleEditInfo()"
                  class="border-border hover:bg-accent flex items-center gap-1.5 rounded-md border
                    px-3 py-1.5 text-xs transition-colors"
                  :class="detail.isEditing ? 'text-red-400 border-red-900/50 bg-red-900/10' : 'text-muted-foreground'"
                >
                  <i x-lucide-dynamic="detail.isEditing ? 'x' : 'pencil'" class="h-3 w-3"></i>
                  <span x-text="detail.isEditing ? '취소' : '편집'"></span>
                </button>
              </div>
              <!-- Info View -->
              <div
                x-show="!detail.isEditing"
                class="grid grid-cols-1 gap-x-8 gap-y-6 md:grid-cols-2"
              >
                <template
                  x-for="label in ['차량번호', '제조사', '차종', '등급', '연식', '연료', '배기량', '누적 주행거리']"
                >
                  <div class="space-y-1">
                    <p
                      class="text-muted-foreground text-xs font-medium tracking-wider uppercase"
                      x-text="label"
                    ></p>
                    <p class="text-lg font-medium" x-text="getCarInfoValue(label)"></p>
                  </div>
                </template>
              </div>

              <!-- Info Edit Form -->
              <template x-if="detail.carInfoEditBuffer">
                <form
                  x-show="detail.isEditing"
                  @submit.prevent="saveCarInfo"
                  class="grid grid-cols-1 gap-4 md:grid-cols-2"
                >
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">차량번호</label>
                    <input
                      type="text"
                      x-model="detail.carInfoEditBuffer.number"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">제조사</label>
                    <input
                      type="text"
                      x-model="detail.carInfoEditBuffer.maker"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">차종</label>
                    <input
                      type="text"
                      x-model="detail.carInfoEditBuffer.model"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">등급</label>
                    <input
                      type="text"
                      x-model="detail.carInfoEditBuffer.grade"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">연식</label>
                    <input
                      type="number"
                      x-model="detail.carInfoEditBuffer.year"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-muted-foreground text-xs font-medium">연료</label>
                    <select
                      x-model="detail.carInfoEditBuffer.fuelType"
                      class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                        bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                        focus-visible:ring-1 focus-visible:outline-none"
                    >
                      <option>휘발유</option>
                      <option>경유</option>
                      <option>LPG</option>
                      <option>전기</option>
                      <option>하이브리드</option>
                    </select>
                  </div>
                  <div class="col-span-full flex justify-end pt-4">
                    <button
                      type="submit"
                      class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex h-9
                        items-center justify-center rounded-md px-4 text-sm font-medium shadow
                        transition-colors"
                    >
                      저장
                    </button>
                  </div>
                </form>
              </template>
            </div>
          </div>

          <!-- Tab: Refuel / Maintenance / Etc -->
          <div
            x-show="['refuel', 'maintenance', 'etc'].includes(detail.tab)"
            class="animate-in fade-in zoom-in-95 flex flex-1 flex-col overflow-hidden duration-200"
          >
            <!-- Dashboard (Refuel Only) -->
            <div x-show="detail.tab === 'refuel'" class="mb-6 flex gap-4">
              <!-- Card 1: Cost Comparison -->
              <div
                class="bg-card border-border flex h-32 max-w-[300px] flex-1 flex-col justify-between
                  rounded-xl border p-4"
              >
                <span class="text-muted-foreground text-xs font-medium">이번 달 주유비</span>
                <div class="mt-2 flex flex-col justify-start gap-1">
                  <span
                    class="text-4xl font-bold tracking-tight"
                    x-text="formatNumber(getMonthlyRefuelCost().current)"
                  ></span>
                  <div
                    class="mt-2 flex items-center gap-1 text-xs font-medium"
                    :class="getMonthlyRefuelCost().diff > 0 ? 'text-red-400' : 'text-green-400'"
                  >
                    <span class="text-muted-foreground">지난달 대비</span>
                    <span x-text="formatNumber(getMonthlyRefuelCost().diff)"></span>
                    <span x-text="getMonthlyRefuelCost().diff > 0 ? '\u25b2' : '\u25bc'"></span>
                  </div>
                </div>
              </div>

              <!-- Card 2: Efficiency Graph -->
              <div
                x-data="chart()"
                x-init="initChart()"
                @mousemove="handleMouseMove"
                @mouseleave="hover = false"
                class="bg-card border-border group relative flex h-32 max-w-[400px] flex-1 flex-col
                  overflow-hidden rounded-xl border p-4 select-none"
              >
                <div class="pointer-events-none relative z-20 mb-4">
                  <span class="text-muted-foreground text-xs font-medium"
                    >최근 연비 추이 (km/L)</span
                  >
                  <div x-show="points.length > 0" class="absolute top-0 right-0 text-right">
                    <div
                      class="text-foreground text-2xl font-bold tabular-nums"
                      x-text="points.at(hover ? hoverIndex : -1)?.val"
                    ></div>
                    <div
                      class="text-muted-foreground text-[10px]"
                      x-text="points.at(hover ? hoverIndex : -1)?.date"
                    ></div>
                  </div>
                </div>

                <div class="relative z-10 min-h-0 w-full flex-1">
                  <template x-if="points.length > 1">
                    <svg
                      class="h-full w-full overflow-visible"
                      viewBox="0 0 100 100"
                      preserveAspectRatio="none"
                    >
                      <defs>
                        <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                          <stop offset="0%" stop-color="white" stop-opacity="0.2" />
                          <stop offset="100%" stop-color="white" stop-opacity="0" />
                        </linearGradient>
                      </defs>

                      <!-- Gradient Area -->
                      <path :d="getAreaPath()" fill="url(#chartGradient)" stroke="none" />

                      <!-- Line -->
                      <path
                        :d="getPath()"
                        fill="none"
                        stroke="white"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        vector-effect="non-scaling-stroke"
                      />

                      <!-- Hover Line & Dot (Custom Scaling) -->
                      <g x-show="hover && hoverIndex > -1">
                        <line
                          :x1="points[hoverIndex]?.x ?? 0"
                          y1="0"
                          :x2="points[hoverIndex]?.x ?? 0"
                          y2="100"
                          stroke="white"
                          stroke-width="1"
                          stroke-dasharray="2 2"
                          opacity="0.5"
                          vector-effect="non-scaling-stroke"
                        />
                      </g>
                    </svg>
                  </template>
                  <template x-if="points.length <= 1">
                    <div
                      class="text-muted-foreground border-border flex h-full w-full items-center
                        justify-center rounded-lg border border-dashed text-xs"
                    >
                      표시할 데이터가 부족합니다.
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- Filter Bar -->
            <div class="mb-4 flex flex-col items-stretch gap-2 sm:flex-row sm:items-center">
              <div class="relative flex-1">
                <i
                  x-lucide="search"
                  class="text-muted-foreground absolute top-1/2 left-2.5 h-4 w-4 -translate-y-1/2"
                >
                </i>
                <input
                  type="text"
                  x-model="filters.search"
                  placeholder="검색..."
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent py-1 pr-3 pl-9 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
              <div class="flex items-center gap-2">
                <div
                  class="bg-card border-input flex h-9 items-center gap-1 rounded-md border px-2"
                >
                  <input
                    type="date"
                    x-model="filters.dateStart"
                    class="text-foreground h-full w-[90px] border-none bg-transparent p-0 text-xs
                      outline-none focus:ring-0"
                  />
                  <span class="text-muted-foreground">~</span>
                  <input
                    type="date"
                    x-model="filters.dateEnd"
                    class="text-foreground h-full w-[90px] border-none bg-transparent p-0 text-xs
                      outline-none focus:ring-0"
                  />
                </div>
                <div x-show="detail.tab === 'maintenance'" class="relative">
                  <select
                    x-model="filters.type"
                    class="border-input focus-visible:ring-ring flex h-9 w-[80px] rounded-md border
                      bg-transparent px-2 py-1 text-xs shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  >
                    <option value="all">전체</option>
                    <option value="maintenance">정비</option>
                    <option value="inspection">점검</option>
                  </select>
                </div>
              </div>
              <button
                @click="openModal('add-record')"
                class="focus-visible:ring-ring bg-primary text-primary-foreground
                  hover:bg-primary/90 inline-flex h-9 items-center justify-center rounded-md px-4
                  text-sm font-medium whitespace-nowrap shadow transition-colors
                  focus-visible:ring-1 focus-visible:outline-none"
              >
                <i x-lucide="plus" class="mr-2 h-4 w-4"></i>
                <span x-text="getAddButtonText()"></span>
              </button>
            </div>

            <!-- List Content -->
            <div class="flex-1 space-y-2 overflow-y-auto pr-1 pb-20">
              <template x-for="(record, index) in filteredRecords" :key="record.id">
                <div
                  class="group bg-card border-border hover:bg-accent/50 relative rounded-lg border
                    p-4 transition-colors"
                >
                  <!-- Delete Button -->
                  <button
                    @click.stop="deleteRecord(record.id)"
                    class="text-muted-foreground bg-popover hover:text-destructive hover:bg-accent
                      absolute top-2 right-2 z-10 rounded-md p-1.5 opacity-0 transition-all
                      group-hover:opacity-100"
                  >
                    <i x-lucide="trash-2" class="h-4 w-4"></i>
                  </button>

                  <div class="mb-2 flex items-start justify-between">
                    <div class="flex items-center gap-2">
                      <span class="text-muted-foreground font-mono text-xs" x-text="record.date">
                      </span>
                      <span
                        class="inline-flex items-center rounded-full border px-2 py-0.5 text-[10px]
                          font-semibold transition-colors"
                        :class="({
                          'border-transparent bg-brand/10 text-brand': ['full', 'maintenance'].includes(record.subType),
                          'border-transparent bg-orange-500/10 text-orange-400': ['partial', 'inspection'].includes(
                            record.subType
                          ),
                          'border-transparent bg-secondary text-secondary-foreground': !record.subType,
                        })"
                        x-text="getSubTypeLabel(record)"
                      >
                      </span>
                    </div>
                    <span
                      class="font-bold tabular-nums"
                      x-text="formatNumber(record.amount) + '원'"
                    >
                    </span>
                  </div>

                  <div class="flex items-end justify-between text-sm">
                    <div class="flex flex-col gap-1">
                      <span
                        class="max-w-[200px] truncate text-[16px] font-bold"
                        x-text="getRecordLabel(record)"
                      >
                      </span>
                      <div class="flex items-center gap-0.5">
                        <div
                          class="text-muted-foreground text-xs tabular-nums"
                          x-text="formatDistance(record.odometer)"
                        ></div>
                        <span class="text-border mx-1">|</span>
                        <span class="text-muted-foreground flex items-center gap-1 text-xs">
                          <i x-lucide="map-pin" class="h-3 w-3"></i>
                          <span x-text="record.place || '장소 미지정'"></span>
                        </span>
                      </div>
                    </div>
                    <div class="flex flex-col items-end gap-0.5 text-right">
                      <template x-if="detail.tab === 'refuel' && record.volume">
                        <div class="flex flex-col items-end">
                          <div class="text-muted-foreground text-[10px]">
                            <span x-text="record.volume + 'L'"></span>
                            <span class="text-border mx-1">|</span>
                            <span x-text="formatNumber(record.unitPrice) + '원/L'"></span>
                          </div>
                          <template x-if="getEfficiency(record, index)">
                            <div
                              class="mt-0.5 flex items-center gap-1 rounded bg-green-900/10 px-1.5
                                py-0.5 text-[10px] font-medium text-green-500"
                            >
                              <span
                                x-text="'+' + formatDistance(getEfficiency(record, index)?.dist ?? 0)"
                              >
                              </span>
                              <span class="text-border">|</span>
                              <span x-text="(getEfficiency(record, index)?.eff ?? 0) + ' km/L'">
                              </span>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
              <template x-if="filteredRecords.length === 0">
                <div class="py-12 text-center">
                  <div
                    class="bg-secondary mb-4 inline-flex h-12 w-12 items-center justify-center
                      rounded-full"
                  >
                    <i x-lucide="inbox" class="text-muted-foreground h-6 w-6"></i>
                  </div>
                  <p class="text-muted-foreground text-sm">내역이 없습니다.</p>
                </div>
              </template>
            </div>
          </div>
        </div>
      </main>
    </div>

    <input
      type="file"
      id="fileInput"
      accept=".json"
      class="hidden"
      @change="handleFileImport($event)"
    />

    <!-- Modals -->
    <div
      x-show="modal.active"
      class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0"
      style="display: none"
    >
      <div
        x-show="modal.active"
        x-transition.opacity
        @click="closeModal()"
        class="bg-background/80 absolute inset-0 backdrop-blur-sm"
      ></div>
      <div
        x-show="modal.active"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95 translate-y-4"
        x-transition:enter-end="opacity-100 scale-100 translate-y-0"
        class="bg-card border-border relative flex max-h-[90vh] w-full max-w-lg flex-col
          overflow-hidden border shadow-lg sm:rounded-lg"
      >
        <div class="border-border flex shrink-0 items-center justify-between border-b p-6">
          <h3 class="text-lg font-semibold" x-text="getModalTitle()"></h3>
          <button @click="closeModal()" class="text-muted-foreground hover:text-foreground">
            <i x-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>
        <div class="space-y-4 overflow-y-auto p-6">
          <!-- Add Car Form -->
          <form x-show="modal.type === 'add-car'" @submit.prevent="submitAddCar" class="space-y-4">
            <div class="grid gap-2">
              <label class="text-sm font-medium">차량 번호</label>
              <input
                type="text"
                x-model="forms.car.number"
                required
                placeholder="예: 12가 3456"
                class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                  bg-transparent px-3 py-1 text-sm shadow-xs transition-colors focus-visible:ring-1
                  focus-visible:outline-none"
              />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="grid gap-2">
                <label class="text-sm font-medium">제조사</label>
                <input
                  type="text"
                  x-model="forms.car.maker"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-sm font-medium">차종</label>
                <input
                  type="text"
                  x-model="forms.car.model"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="grid gap-2">
                <label class="text-sm font-medium">연식</label>
                <input
                  type="number"
                  x-model="forms.car.year"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-sm font-medium">연료</label>
                <select
                  x-model="forms.car.fuelType"
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                >
                  <option>휘발유</option>
                  <option>경유</option>
                  <option>LPG</option>
                  <option>전기</option>
                  <option>하이브리드</option>
                </select>
              </div>
            </div>
            <div class="grid gap-2">
              <label class="text-sm font-medium">현재 주행거리 (km)</label>
              <input
                type="number"
                x-model="forms.car.totalDistance"
                class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                  bg-transparent px-3 py-1 text-sm shadow-xs transition-colors focus-visible:ring-1
                  focus-visible:outline-none"
              />
            </div>
            <div class="flex justify-end pt-4">
              <button
                type="submit"
                class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex h-9
                  items-center justify-center rounded-md px-4 text-sm font-medium shadow
                  transition-colors"
              >
                저장
              </button>
            </div>
          </form>

          <!-- Add Record Form -->
          <form
            x-show="modal.type === 'add-record'"
            @submit.prevent="submitAddRecord"
            class="space-y-4"
          >
            <div class="grid grid-cols-2 gap-4">
              <div class="grid gap-2">
                <label class="text-sm font-medium">날짜</label>
                <input
                  type="date"
                  x-model="forms.record.date"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>

              <!-- Autocomplete for Place -->
              <div class="relative grid gap-2" @click.outside="autocomplete.open = false">
                <label class="text-sm font-medium">장소</label>
                <input
                  type="text"
                  x-model="forms.record.place"
                  @focus="autocomplete.open = true"
                  @input="autocomplete.open = true"
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                  placeholder="장소 검색 또는 입력"
                />

                <!-- Dropdown -->
                <div
                  x-show="autocomplete.open && filteredPlaces.length > 0"
                  class="border-border bg-popover text-popover-foreground absolute top-full left-0
                    z-50 mt-1 w-full overflow-hidden rounded-md border shadow-md"
                >
                  <ul class="max-h-[200px] overflow-auto py-1">
                    <template x-for="place in filteredPlaces" :key="place">
                      <li
                        @click="forms.record.place = place; autocomplete.open = false"
                        class="hover:bg-accent hover:text-accent-foreground flex cursor-pointer
                          items-center gap-2 px-3 py-2 text-sm"
                      >
                        <i x-lucide="map-pin" class="text-muted-foreground h-3 w-3"></i>
                        <span x-text="place"></span>
                      </li>
                    </template>
                  </ul>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="grid gap-2">
                <label class="text-sm font-medium">누적 주행거리 (km)</label>
                <input
                  type="number"
                  x-model="forms.record.odometer"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-sm font-medium">금액 (원)</label>
                <input
                  type="number"
                  x-model="forms.record.amount"
                  @input="calculateVolume"
                  required
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
            </div>
            <!-- Type: Refuel -->
            <div x-show="detail.tab === 'refuel'" class="border-border space-y-4 border-t pt-2">
              <div class="grid grid-cols-2 gap-4">
                <div class="grid gap-2">
                  <label class="text-sm font-medium">구분</label>
                  <select
                    x-model="forms.record.subType"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  >
                    <option value="full">가득(상한)</option>
                    <option value="partial">부분주유</option>
                  </select>
                </div>
                <div class="grid gap-2">
                  <label class="text-sm font-medium">단가 (원/L)</label>
                  <input
                    type="number"
                    x-model="forms.record.unitPrice"
                    @input="calculateVolume"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="grid gap-2">
                  <label class="text-sm font-medium">주유량 (L)</label>
                  <input
                    type="number"
                    step="0.01"
                    x-model="forms.record.volume"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  />
                </div>
                <div class="grid gap-2" x-show="forms.record.subType === 'full'">
                  <label class="text-sm font-medium">연료게이지 (%)</label>
                  <input
                    type="number"
                    x-model="forms.record.fuelGauge"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  />
                </div>
              </div>
            </div>
            <!-- Type: Maintenance -->
            <div
              x-show="detail.tab === 'maintenance'"
              class="border-border space-y-4 border-t pt-2"
            >
              <div class="grid grid-cols-2 gap-4">
                <div class="grid gap-2">
                  <label class="text-sm font-medium">구분</label>
                  <select
                    x-model="forms.record.subType"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  >
                    <option value="maintenance">정비</option>
                    <option value="inspection">점검</option>
                  </select>
                </div>
                <div class="grid gap-2">
                  <label class="text-sm font-medium">항목</label>
                  <input
                    type="text"
                    x-model="forms.record.item"
                    placeholder="엔진오일 교환"
                    class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                      bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                      focus-visible:ring-1 focus-visible:outline-none"
                  />
                </div>
              </div>
              <div class="grid gap-2">
                <label class="text-sm font-medium">메모</label>
                <textarea
                  x-model="forms.record.memo"
                  class="border-input placeholder:text-muted-foreground focus-visible:ring-ring flex
                    min-h-[60px] w-full rounded-md border bg-transparent px-3 py-2 text-sm shadow-xs
                    focus-visible:ring-1 focus-visible:outline-none"
                >
                </textarea>
              </div>
            </div>
            <!-- Type: Etc -->
            <div x-show="detail.tab === 'etc'" class="border-border space-y-4 border-t pt-2">
              <div class="grid gap-2">
                <label class="text-sm font-medium">항목</label>
                <input
                  type="text"
                  x-model="forms.record.item"
                  placeholder="세차, 주차비 등"
                  class="border-input focus-visible:ring-ring flex h-9 w-full rounded-md border
                    bg-transparent px-3 py-1 text-sm shadow-xs transition-colors
                    focus-visible:ring-1 focus-visible:outline-none"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-sm font-medium">메모</label>
                <textarea
                  x-model="forms.record.memo"
                  class="border-input placeholder:text-muted-foreground focus-visible:ring-ring flex
                    min-h-[60px] w-full rounded-md border bg-transparent px-3 py-2 text-sm shadow-xs
                    focus-visible:ring-1 focus-visible:outline-none"
                >
                </textarea>
              </div>
            </div>
            <div class="flex justify-end pt-4">
              <button
                type="submit"
                class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex h-9
                  items-center justify-center rounded-md px-4 text-sm font-medium shadow
                  transition-colors"
              >
                추가하기
              </button>
            </div>
          </form>

          <!-- WebDAV -->
          <div x-show="modal.type === 'webdav-config'">
            <div class="flex justify-end pt-4">
              <button
                @click="connectWebDAVSim()"
                class="bg-primary text-primary-foreground inline-flex h-9 items-center
                  justify-center rounded-md px-4 text-sm font-medium shadow"
              >
                연결
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div
      class="pointer-events-none fixed bottom-6 left-1/2 z-[60] flex -translate-x-1/2 flex-col
        gap-2"
    >
      <template x-for="toast in toasts" :key="toast.id">
        <div
          x-show="toast.visible"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="translate-y-2 opacity-0"
          x-transition:enter-end="translate-y-0 opacity-100"
          class="bg-background inline-flex items-center justify-center rounded-md border px-4 py-2.5
            text-sm font-medium shadow-md transition-all"
          :class="({
            'border-border text-foreground': toast.type === 'info',
            'border-green-900 bg-green-950 text-green-100': toast.type === 'success',
            'border-red-900 bg-red-950 text-red-100': toast.type === 'error',
          })"
        >
          <span x-text="toast.message"></span>
        </div>
      </template>
    </div>

    <script>
      const Backend = {
        DB_KEY: 'vehlog_db',
        load() {
          const r = localStorage.getItem(this.DB_KEY);
          return r ? JSON.parse(r) : null;
        },
        save(d) {
          localStorage.setItem(this.DB_KEY, JSON.stringify(d));
          return true;
        },
        initNew() {
          const d = { config: { type: 'local' }, cars: [], records: [] };
          this.save(d);
          return d;
        },
      };

      document.addEventListener('alpine:init', () => {
        Alpine.directive('lucide', (el, { expression }, { evaluate }) => {
          if (el.tagName.toLowerCase() !== 'i') return;
          el.setAttribute('data-lucide', expression);
          lucide.createIcons({
            attrs: { class: el.getAttribute('class') },
            nameAttr: 'data-lucide',
            root: el.parentElement,
          });
        });

        Alpine.directive('lucide-dynamic', (el, { expression }, { evaluate }) => {
          if (el.tagName.toLowerCase() !== 'i') return;
          el.setAttribute('data-lucide', evaluate(expression));
          lucide.createIcons({
            attrs: { class: el.getAttribute('class') },
            nameAttr: 'data-lucide',
            root: el.parentElement,
          });
        });

        Alpine.store('app', {
          db: null,
          detail: { tab: 'info' },
          getEfficiencyHistory() {
            if (!this.db || !this.detail.carId) return [];
            const detail = this.detail;

            let records = this.db.records.filter(
              x => x.carId === detail.carId && x.type === 'refuel'
            );

            records.sort((a, b) => b.odometer - a.odometer);

            const history = [];
            for (let i = 0; i < Math.min(records.length - 1, 20); i++) {
              const rec = records[i];
              const prev = records[i + 1];
              if (rec.volume && prev) {
                const dist = rec.odometer - prev.odometer;
                if (dist > 0) {
                  history.push({
                    date: rec.date.substring(5),
                    val: parseFloat((dist / rec.volume).toFixed(1)),
                  });
                }
              }
            }
            return history.reverse();
          },
        });

        Alpine.data('app', () => ({
          router: { current: 'onboarding' },

          get db() {
            return Alpine.store('app').db;
          },
          set db(val) {
            Alpine.store('app').db = val;
          },

          modal: { active: false, type: null },

          get detail() {
            return Alpine.store('app').detail;
          },
          set detail(val) {
            Alpine.store('app').detail = val;
          },

          forms: {
            car: {
              number: '',
              maker: '',
              model: '',
              year: '',
              fuelType: '휘발유',
              totalDistance: '',
            },
            record: {},
          },

          autocomplete: { open: false },
          filters: { dateStart: '', dateEnd: '', type: 'all', search: '' },
          toasts: [],

          init() {
            const d = Backend.load();
            if (d) {
              this.db = d;
              this.router.current = 'car-list';
            }
          },

          get activeCar() {
            return this.db?.cars.find(c => c.id === this.detail.carId) || null;
          },

          get filteredRecords() {
            if (!this.db || !this.detail.carId) return [];

            let r = this.db.records.filter(
              x => x.carId === this.detail.carId && x.type === this.detail.tab
            );

            r.sort((a, b) => {
              if (b.date !== a.date) return new Date(b.date) - new Date(a.date);
              return b.odometer - a.odometer;
            });

            if (this.filters.dateStart) {
              r = r.filter(x => x.date >= this.filters.dateStart);
            }

            if (this.filters.dateEnd) {
              r = r.filter(x => x.date <= this.filters.dateEnd);
            }

            if (this.detail.tab === 'maintenance' && this.filters.type !== 'all') {
              r = r.filter(x => x.subType === this.filters.type);
            }

            if (this.filters.search) {
              const q = this.filters.search.toLowerCase();
              r = r.filter(x => (x.item + x.place + x.memo).toLowerCase().includes(q));
            }

            return r;
          },

          get placeSuggestions() {
            return [...new Set(this.db?.records.map(r => r.place).filter(Boolean))];
          },

          get filteredPlaces() {
            const q = (this.forms.record.place || '').toLowerCase();
            return this.placeSuggestions.filter(p => p.toLowerCase().includes(q));
          },

          getEfficiency(record, index) {
            if (this.detail.tab !== 'refuel' || !record.volume) return null;

            const records = this.filteredRecords;
            if (index >= records.length - 1) return null;

            const prevRecord = records[index + 1];
            const dist = record.odometer - prevRecord.odometer;
            if (dist <= 0) return null;

            return { dist: dist, eff: (dist / record.volume).toFixed(1) };
          },

          getMonthlyRefuelCost() {
            if (!this.db || !this.detail.carId) return { current: 0, diff: 0 };
            const currentDate = new Date();
            const lastMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);

            const records = this.db.records.filter(
              r => r.carId === this.detail.carId && r.type === 'refuel'
            );

            const curTotal = records
              .filter(r => {
                const date = new Date(r.date);
                return date.getFullYear() === currentDate.getFullYear()
                  && date.getMonth() === currentDate.getMonth();
              })
              .reduce((acc, r) => acc + r.amount, 0);

            const lastTotal = records
              .filter(r => {
                const date = new Date(r.date);
                return date.getFullYear() === lastMonthDate.getFullYear()
                  && date.getMonth() === lastMonthDate.getMonth();
              })
              .reduce((acc, r) => acc + r.amount, 0);

            return { current: curTotal, diff: curTotal - lastTotal };
          },

          getEfficiencyHistory() {
            return Alpine.store('app').getEfficiencyHistory();
          },

          createLocalDatabase() {
            this.db = Backend.initNew();
            this.router.current = 'car-list';
          },

          openModal(t) {
            this.modal.type = t;
            this.modal.active = true;

            if (t === 'add-car') {
              this.forms.car = {
                number: '',
                maker: '',
                model: '',
                year: 2024,
                fuelType: '휘발유',
                totalDistance: '',
              };
            }

            if (t === 'add-record') {
              const today = new Date().toISOString().split('T')[0];
              this.forms.record = {
                date: today,
                odometer: this.activeCar?.totalDistance || 0,
                amount: '',
                place: '',
                subType:
                  this.detail.tab === 'refuel'
                    ? 'full'
                    : this.detail.tab === 'maintenance'
                      ? 'maintenance'
                      : '',
                unitPrice: '',
                volume: '',
                fuelGauge: '',
                item: '',
                memo: '',
              };
              this.autocomplete.open = false;
            }
          },

          closeModal() {
            this.modal.active = false;
            setTimeout(() => (this.modal.type = null), 200);
          },

          submitAddCar() {
            const c = {
              id: crypto.randomUUID(),
              ...this.forms.car,
              totalDistance: Number(this.forms.car.totalDistance) || 0,
              createdAt: new Date().toISOString(),
            };
            this.db.cars.push(c);
            this.autoSave();
            this.closeModal();
            this.showToast('차량 추가됨', 'success');
          },

          submitAddRecord() {
            const r = this.forms.record;
            const rec = {
              id: crypto.randomUUID(),
              carId: this.detail.carId,
              type: this.detail.tab,
              date: r.date,
              amount: Number(r.amount) || 0,
              odometer: Number(r.odometer) || 0,
              place: r.place,
              subType: r.subType,
              unitPrice: Number(r.unitPrice) || null,
              volume: Number(r.volume) || null,
              fuelGauge: Number(r.fuelGauge) || null,
              item: r.item,
              memo: r.memo,
              createdAt: new Date().toISOString(),
            };

            this.db.records.push(rec);

            const car = this.db.cars.find(c => c.id === this.detail.carId);
            if (car && rec.odometer > car.totalDistance) {
              car.totalDistance = rec.odometer;
            }

            this.autoSave();
            this.closeModal();
            this.showToast('기록 추가됨', 'success');
          },

          deleteRecord(id) {
            if (confirm('정말로 이 기록을 삭제하시겠습니까?')) {
              this.db.records = this.db.records.filter(r => r.id !== id);
              this.autoSave();
              this.showToast('기록이 삭제되었습니다.', 'success');
            }
          },

          selectCar(id) {
            this.detail.carId = id;
            this.detail.tab = 'info';
            this.router.current = 'car-detail';
          },

          toggleEditInfo() {
            if (this.detail.isEditing) {
              this.detail.isEditing = false;
            } else {
              this.detail.carInfoEditBuffer = { ...this.activeCar };
              this.detail.isEditing = true;
            }
          },

          saveCarInfo() {
            const idx = this.db.cars.findIndex(c => c.id === this.detail.carId);
            if (idx > -1) {
              this.db.cars[idx] = {
                ...this.db.cars[idx],
                ...this.detail.carInfoEditBuffer,
                year: Number(this.detail.carInfoEditBuffer.year),
              };
              this.autoSave();
              this.detail.isEditing = false;
              this.showToast('정보 저장됨', 'success');
            }
          },

          autoSave() {
            if (this.db) Backend.save(this.db);
          },

          calculateVolume() {
            if (
              this.detail.tab === 'refuel' &&
              this.forms.record.amount &&
              this.forms.record.unitPrice
            ) {
              this.forms.record.volume = (
                this.forms.record.amount / this.forms.record.unitPrice
              ).toFixed(2);
            }
          },

          getAddButtonText() {
            return (
              {
                refuel: '주유 추가',
                maintenance: '정비 추가',
                etc: '지출 추가',
              }[this.detail.tab] || '추가'
            );
          },

          getModalTitle() {
            return (
              { 'add-car': '차량 추가', 'add-record': '새로운 기록' }[this.modal.type] || '설정'
            );
          },

          getCarInfoValue(label) {
            const c = this.activeCar;
            if (!c) return '-';
            const m = {
              '차량번호': c.number,
              '제조사': c.maker,
              '차종': c.model,
              '등급': c.grade,
              '연식': c.year + '년',
              '연료': c.fuelType,
              '배기량': c.displacement ? this.formatNumber(c.displacement) + 'cc' : '-',
              '누적 주행거리': this.formatDistance(c.totalDistance),
            };
            return m[label];
          },

          getSubTypeLabel(r) {
            const m = {
              full: '가득',
              partial: '부분',
              maintenance: '정비',
              inspection: '점검',
            };
            return m[r.subType] || (this.detail.tab === 'etc' ? '지출' : '-');
          },

          getRecordLabel(r) {
            return r.volume ? `${r.volume}L` : r.item || r.title || '내역 없음';
          },

          formatDistance(k) {
            return new Intl.NumberFormat('ko-KR').format(k) + 'km';
          },

          formatNumber(n) {
            return new Intl.NumberFormat('ko-KR').format(n);
          },

          showToast(msg, type = 'info') {
            const id = Date.now();
            this.toasts.push({ id, message: msg, type, visible: true });
            setTimeout(() => (this.toasts.find(t => t.id === id).visible = false), 3000);
            setTimeout(() => (this.toasts = this.toasts.filter(t => t.id !== id)), 3500);
          },

          exportDB() {
            if (!this.db) return;
            const a = document.createElement('a');
            a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.db));
            a.download = `vehlog_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
          },

          triggerImport() {
            document.getElementById('fileInput').click();
          },

          handleFileImport(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              try {
                this.db = JSON.parse(ev.target.result);
                Backend.save(this.db);
                this.router.current = 'car-list';
                this.showToast('복원됨', 'success');
              } catch (e) {
                this.showToast('오류', 'error');
              }
            };
            r.readAsText(f);
            e.target.value = '';
          },

          connectWebDAVSim() {
            this.closeModal();
            this.db = Backend.initNew();
            this.router.current = 'car-list';
          },

          closeDatabase() {
            this.db = null;
            this.router.current = 'onboarding';
          },
        }));

        Alpine.data('chart', () => ({
          hover: false,
          hoverX: 0,
          hoverIndex: -1,
          points: [],

          initChart() {
            this.$watch('$store.app.detail.tab', () => this.calcPoints());
            this.$watch('$store.app.db', () => this.calcPoints());
            this.calcPoints();
          },

          calcPoints() {
            const history = this.$store.app.getEfficiencyHistory();
            if (history.length < 2) {
              this.points = [];
              return;
            }
            const maxVal = Math.max(...history.map(p => p.val));
            const minVal = Math.min(...history.map(p => p.val));
            const range = maxVal - minVal || 1;
            // Padding: top 20%, bottom 20%
            const yBase = 80;
            const yScale = 60 / range;

            this.points = history.map((pt, i) => ({
              x: (i / (history.length - 1)) * 100,
              y: 80 - (pt.val - minVal) * yScale,
              val: pt.val,
              date: pt.date,
            }));
          },

          getPath() {
            if (this.points.length < 2) return '';
            return this.points.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ');
          },

          getAreaPath() {
            if (this.points.length < 2) return '';
            const path = this.getPath();
            return `${path} L 100,100 L 0,100 Z`;
          },

          handleMouseMove(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;

            // Find closest point
            let minDist = 1000;
            this.points.forEach((p, i) => {
              const dist = Math.abs(p.x - x);
              if (dist < minDist) {
                minDist = dist;
                this.hoverIndex = i;
              }
            });

            this.hoverX = this.points[this.hoverIndex].x;
            this.hover = true;
          },
        }));
      });
    </script>
  </body>
</html>
