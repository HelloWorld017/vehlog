<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cha-Gye-Bu | 차량 관리 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#09090b', // Zinc 950
                            800: '#18181b', // Zinc 900
                            700: '#27272a', // Zinc 800
                            600: '#3f3f46', // Zinc 700
                            border: '#27272a'
                        },
                        brand: {
                            DEFAULT: '#6366f1', // Indigo 500
                            hover: '#4f46e5',   // Indigo 600
                            bg: 'rgba(99, 102, 241, 0.1)'
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for Dark Mode */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        /* Glassmorphism utilities */
        .glass {
            background: rgba(24, 24, 27, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-dark-900 text-gray-200 font-sans antialiased min-h-screen selection:bg-brand selection:text-white overflow-x-hidden"
      x-data="app()">

    <!-- Background Gradients -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-brand/20 blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-purple-900/20 blur-[120px]"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-5xl mx-auto px-4 py-8 h-screen flex flex-col">
        
        <!-- Header -->
        <header x-show="router.current === 'car-list'" x-transition 
                class="flex justify-between items-center mb-8 pb-4 border-b border-dark-border">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-brand flex items-center justify-center text-white font-bold">
                    <i data-lucide="car-front"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">Cha-Gye-Bu</h1>
            </div>
            
            <div class="flex gap-2">
                <!-- DB Settings Dropdown -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open" class="p-2 rounded-md hover:bg-dark-700 text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    
                    <div x-show="open" @click.outside="open = false" 
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         class="absolute right-0 mt-2 w-48 bg-dark-800 border border-dark-600 rounded-lg shadow-xl py-1 z-50">
                        <button @click="exportDB(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-300 hover:bg-dark-700 text-left">
                            <i data-lucide="download" class="w-4 h-4"></i> 내보내기 (JSON)
                        </button>
                        <button @click="triggerImport(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-300 hover:bg-dark-700 text-left">
                            <i data-lucide="upload" class="w-4 h-4"></i> 가져오기
                        </button>
                        <div class="h-px bg-dark-600 my-1"></div>
                        <button @click="closeDatabase(); open = false" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-red-400 hover:bg-dark-700 text-left">
                            <i data-lucide="log-out" class="w-4 h-4"></i> 데이터베이스 닫기
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- View: Onboarding -->
        <main x-show="router.current === 'onboarding'" 
              x-transition:enter="transition ease-out duration-300 delay-100"
              class="flex-1 flex flex-col justify-center items-center text-center">
            <!-- (Onboarding content same as before) -->
            <div class="mb-8 relative">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand to-purple-600 flex items-center justify-center shadow-lg shadow-brand/20">
                    <i data-lucide="database" class="w-10 h-10 text-white"></i>
                </div>
            </div>
            
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 tracking-tight">
                차계부 관리의 시작
            </h1>
            <p class="text-gray-400 max-w-md mb-12 text-lg">
                안전하게 내 차의 모든 기록을 관리하세요.<br>
                데이터는 브라우저에 저장되거나 클라우드와 연동됩니다.
            </p>

            <div class="grid md:grid-cols-2 gap-4 w-full max-w-2xl">
                <button @click="createLocalDatabase()" 
                        class="group p-6 rounded-xl border border-dark-600 bg-dark-800 hover:bg-dark-700 hover:border-brand transition-all duration-300 text-left relative overflow-hidden">
                    <div class="absolute inset-0 bg-brand/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-white">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">새 데이터베이스 만들기</h3>
                    <p class="text-sm text-gray-400">로컬 저장소에 새로운 차계부를 생성합니다. 빠르고 간편합니다.</p>
                </button>
                <button @click="openModal('webdav-config')"
                        class="group p-6 rounded-xl border border-dark-600 bg-dark-800 hover:bg-dark-700 hover:border-gray-500 transition-all duration-300 text-left">
                    <div class="w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-white">
                        <i data-lucide="globe" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">WebDAV 연결하기</h3>
                    <p class="text-sm text-gray-400">개인 NAS나 클라우드 저장소에 있는 차계부 파일을 불러옵니다.</p>
                </button>
            </div>
            <div class="mt-8 text-sm text-gray-500">
                <button @click="triggerImport()" class="hover:text-gray-300 underline underline-offset-4">
                    이미 백업 파일(.json)이 있으신가요?
                </button>
            </div>
        </main>

        <!-- View: Car Selection (List) -->
        <main x-show="router.current === 'car-list'" 
              x-transition:enter="transition ease-out duration-300"
              class="flex-1">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white">나의 차량</h2>
                    <p class="text-gray-400 text-sm mt-1">관리할 차량을 선택하거나 추가하세요.</p>
                </div>
                <button @click="openModal('add-car')" 
                        class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-md font-medium text-sm flex items-center gap-2 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i> 차량 추가
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="car in db.cars" :key="car.id">
                    <div @click="selectCar(car.id)" 
                         class="group relative bg-dark-800 border border-dark-600 rounded-xl p-5 cursor-pointer hover:border-brand/50 hover:bg-dark-800/80 transition-all duration-200 overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-brand/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-dark-700 text-gray-300 border border-dark-600" x-text="car.fuelType"></span>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 group-hover:text-white transition-colors"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white tracking-tight" x-text="car.number"></h3>
                                <p class="text-gray-400 text-sm" x-text="car.maker + ' ' + car.model"></p>
                            </div>
                            <div class="mt-6 pt-4 border-t border-dark-700 flex justify-between text-xs text-gray-500">
                                <span x-text="car.year + '년식'"></span>
                                <span x-text="formatDistance(car.totalDistance)"></span>
                            </div>
                        </div>
                    </div>
                </template>
                <template x-if="db.cars.length === 0">
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500 border border-dashed border-dark-600 rounded-xl bg-dark-800/30">
                        <i data-lucide="car" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p class="text-lg font-medium">등록된 차량이 없습니다.</p>
                        <p class="text-sm mt-1">우측 상단의 버튼을 눌러 첫 차량을 등록해보세요.</p>
                    </div>
                </template>
            </div>
        </main>

        <!-- View: Car Detail -->
        <main x-show="router.current === 'car-detail'"
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0 translate-x-4"
              x-transition:enter-end="opacity-100 translate-x-0"
              class="flex-1 flex flex-col overflow-hidden h-full">
            
            <!-- Detail Header -->
            <div class="flex items-center gap-4 mb-6 pt-2">
                <button @click="router.current = 'car-list'" class="p-2 -ml-2 rounded-full hover:bg-dark-700 text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div>
                    <h2 class="text-2xl font-bold text-white tracking-tight" x-text="activeCar?.number"></h2>
                    <p class="text-sm text-gray-400" x-text="activeCar?.model ? (activeCar?.maker + ' ' + activeCar?.model) : '차종 정보 없음'"></p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-1 mb-6 border-b border-dark-600 overflow-x-auto">
                <template x-for="tab in ['info', 'refuel', 'maintenance', 'etc']">
                    <button @click="detail.tab = tab"
                            class="px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap"
                            :class="detail.tab === tab ? 'border-brand text-white' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-dark-500'">
                        <span x-text="{
                            'info': '차량 정보',
                            'refuel': '주유',
                            'maintenance': '정비',
                            'etc': '기타'
                        }[tab]"></span>
                    </button>
                </template>
            </div>

            <!-- Tab Content: Info -->
            <div x-show="detail.tab === 'info'" class="flex-1 overflow-y-auto pb-20">
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-6 relative">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="info" class="w-5 h-5 text-brand"></i>
                            기본 정보
                        </h3>
                        <button @click="toggleEditInfo()" 
                                class="text-sm px-3 py-1.5 rounded-md transition-colors flex items-center gap-1.5"
                                :class="detail.isEditing ? 'bg-red-500/10 text-red-400 hover:bg-red-500/20' : 'bg-dark-700 text-gray-300 hover:bg-dark-600'">
                            <i :data-lucide="detail.isEditing ? 'x' : 'pencil'" class="w-3.5 h-3.5"></i>
                            <span x-text="detail.isEditing ? '취소' : '편집'"></span>
                        </button>
                    </div>

                    <!-- View Mode (Info) -->
                    <div x-show="!detail.isEditing" class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8">
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">차량번호</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.number || '-'"></p>
                        </div>
                         <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">제조사</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.maker || '-'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">차종</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.model || '-'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">등급 (Trim)</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.grade || '-'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">연식</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.year ? activeCar?.year + '년' : '-'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">연료</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.fuelType || '-'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">배기량</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.displacement ? formatNumber(activeCar?.displacement) + ' cc' : '-'"></p>
                        </div>
                         <div class="space-y-1">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">누적 주행거리</p>
                            <p class="text-lg text-white font-medium" x-text="activeCar?.totalDistance ? formatDistance(activeCar?.totalDistance) : '-'"></p>
                        </div>
                    </div>

                    <!-- Edit Mode (Info) -->
                    <form x-show="detail.isEditing" @submit.prevent="saveCarInfo" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">차량번호</label>
                            <input type="text" x-model="detail.editBuffer.number" required class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">제조사</label>
                            <input type="text" x-model="detail.editBuffer.maker" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">차종</label>
                            <input type="text" x-model="detail.editBuffer.model" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">등급 (Trim)</label>
                            <input type="text" x-model="detail.editBuffer.grade" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">연식</label>
                            <input type="number" x-model="detail.editBuffer.year" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                         <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">연료</label>
                            <select x-model="detail.editBuffer.fuelType" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                                <option value="휘발유">휘발유</option>
                                <option value="경유">경유</option>
                                <option value="LPG">LPG</option>
                                <option value="전기">전기</option>
                                <option value="하이브리드">하이브리드</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">배기량 (cc)</label>
                            <input type="number" x-model="detail.editBuffer.displacement" class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium">현재 주행거리 (수정불가)</label>
                            <input type="text" :value="formatDistance(detail.editBuffer.totalDistance || 0)" disabled class="w-full bg-dark-900/50 border border-dark-600 rounded-lg px-3 py-2 text-gray-500 cursor-not-allowed">
                             <p class="text-[10px] text-gray-500 mt-1">* 주행거리는 기록 추가 시 자동 업데이트됩니다.</p>
                        </div>
                        <div class="col-span-full pt-4 flex justify-end">
                            <button type="submit" class="bg-brand hover:bg-brand-hover text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-lg shadow-brand/20">변경사항 저장</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab Content: Refuel / Maintenance / Etc -->
            <div x-show="['refuel', 'maintenance', 'etc'].includes(detail.tab)" class="flex-1 flex flex-col overflow-hidden">
                
                <!-- Filters -->
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 mb-4 flex flex-wrap gap-3 items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-sm font-medium text-gray-300">필터</span>
                    </div>
                    
                    <!-- Date Filter -->
                    <input type="date" x-model="filters.dateStart" class="bg-dark-900 border border-dark-600 rounded px-2 py-1.5 text-xs text-white focus:border-brand focus:outline-none">
                    <span class="text-gray-500 text-xs">~</span>
                    <input type="date" x-model="filters.dateEnd" class="bg-dark-900 border border-dark-600 rounded px-2 py-1.5 text-xs text-white focus:border-brand focus:outline-none">

                    <!-- Type Filter (Maintenance Only) -->
                    <div x-show="detail.tab === 'maintenance'" class="relative">
                        <select x-model="filters.type" class="bg-dark-900 border border-dark-600 rounded px-2 py-1.5 text-xs text-white focus:border-brand focus:outline-none pr-8 appearance-none">
                            <option value="all">전체</option>
                            <option value="maintenance">정비</option>
                            <option value="inspection">점검</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-gray-500 pointer-events-none"></i>
                    </div>

                    <!-- Search -->
                    <div class="flex-1 min-w-[150px] relative">
                        <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-500"></i>
                        <input type="text" x-model="filters.search" placeholder="검색어 입력..." 
                               class="w-full bg-dark-900 border border-dark-600 rounded-full pl-8 pr-3 py-1.5 text-xs text-white focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand">
                    </div>
                </div>

                <!-- List -->
                <div class="flex-1 overflow-y-auto pb-20 space-y-3">
                    
                    <!-- Add Button -->
                    <button @click="openModal('add-record')" class="w-full p-4 rounded-xl border border-dashed border-dark-600 hover:border-brand hover:bg-brand/5 transition-all flex items-center justify-center gap-2 text-gray-400 hover:text-brand group">
                        <div class="w-8 h-8 rounded-full bg-dark-700 group-hover:bg-brand group-hover:text-white flex items-center justify-center transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </div>
                        <span class="font-medium text-sm">새로운 내역 추가하기</span>
                    </button>

                    <!-- History Items -->
                    <template x-for="record in filteredRecords" :key="record.id">
                        <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 hover:bg-dark-700/50 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-mono text-gray-400" x-text="record.date"></span>
                                    <span class="px-1.5 py-0.5 rounded text-[10px] font-medium border"
                                          :class="{
                                            'bg-blue-500/10 text-blue-400 border-blue-500/20': record.subType === 'full' || record.subType === 'maintenance',
                                            'bg-orange-500/10 text-orange-400 border-orange-500/20': record.subType === 'partial' || record.subType === 'inspection',
                                            'bg-gray-500/10 text-gray-400 border-gray-500/20': detail.tab === 'etc'
                                          }"
                                          x-text="getSubTypeLabel(record)"></span>
                                </div>
                                <span class="text-white font-bold" x-text="formatNumber(record.amount) + '원'"></span>
                            </div>
                            
                            <div class="flex justify-between items-center text-sm">
                                <div class="flex flex-col">
                                    <span class="text-white font-medium truncate max-w-[180px]" 
                                          x-text="record.title || record.item || record.place || '내역 없음'"></span>
                                    <span class="text-xs text-gray-500" x-text="record.place"></span>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400" x-text="formatDistance(record.odometer)"></div>
                                    <!-- 주유 탭 전용 정보 -->
                                    <template x-if="detail.tab === 'refuel' && record.volume">
                                        <div class="text-[10px] text-gray-500 mt-0.5">
                                            <span x-text="record.volume + 'L'"></span>
                                            <span class="mx-1">/</span>
                                            <span x-text="formatNumber(record.unitPrice) + '원'"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Empty State for List -->
                    <template x-if="filteredRecords.length === 0">
                        <div class="text-center py-10 text-gray-500">
                            <p class="text-sm">표시할 내역이 없습니다.</p>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden Input for File Import -->
    <input type="file" id="fileInput" accept=".json" class="hidden" @change="handleFileImport($event)">

    <!-- Modals -->
    <div x-show="modal.active" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <!-- Backdrop -->
        <div x-show="modal.active" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="closeModal()"
             class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Content Container -->
        <div x-show="modal.active"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
             class="relative w-full max-w-md bg-dark-800 border border-dark-600 rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            
            <!-- Header -->
            <div class="p-6 border-b border-dark-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-white" x-text="getModalTitle()"></h3>
                <button @click="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <!-- Scrollable Body -->
            <div class="p-6 overflow-y-auto">
                
                <!-- Modal: Add Car -->
                <form x-show="modal.type === 'add-car'" @submit.prevent="submitAddCar" class="space-y-4">
                     <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">차량 번호</label>
                        <input type="text" x-model="forms.car.number" required placeholder="예: 12가 3456" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">제조사</label>
                        <input type="text" x-model="forms.car.maker" required placeholder="예: 현대" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">차종</label>
                        <input type="text" x-model="forms.car.model" required placeholder="예: 쏘나타" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">연식</label>
                            <input type="number" x-model="forms.car.year" required placeholder="2024" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">연료</label>
                            <select x-model="forms.car.fuelType" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                                <option value="휘발유">휘발유</option>
                                <option value="경유">경유</option>
                                <option value="LPG">LPG</option>
                                <option value="전기">전기</option>
                                <option value="하이브리드">하이브리드</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">현재 주행거리 (km)</label>
                        <input type="number" x-model="forms.car.totalDistance" placeholder="0" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand">
                    </div>
                    <div class="pt-4 flex justify-end gap-2">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-dark-700">취소</button>
                        <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium bg-white text-black hover:bg-gray-200">저장</button>
                    </div>
                </form>

                <!-- Modal: Add Record (Refuel/Maint/Etc) -->
                <form x-show="modal.type === 'add-record'" @submit.prevent="submitAddRecord" class="space-y-4">
                    
                    <!-- Common Fields -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-1">
                            <label class="block text-xs font-medium text-gray-400 mb-1">날짜</label>
                            <input type="date" x-model="forms.record.date" required class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                        <div class="col-span-1">
                             <label class="block text-xs font-medium text-gray-400 mb-1">장소명</label>
                             <input type="text" x-model="forms.record.place" list="placeOptions" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                             <datalist id="placeOptions">
                                 <template x-for="p in placeSuggestions" :key="p">
                                     <option :value="p"></option>
                                 </template>
                             </datalist>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                         <div class="col-span-1">
                            <label class="block text-xs font-medium text-gray-400 mb-1">누적 주행거리 (km)</label>
                            <input type="number" x-model="forms.record.odometer" required class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-medium text-gray-400 mb-1">금액 (원)</label>
                            <input type="number" x-model="forms.record.amount" @input="calculateVolume" required class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                    </div>

                    <!-- Type Specific Fields: Refuel -->
                    <div x-show="detail.tab === 'refuel'" class="space-y-4 border-t border-dark-700 pt-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">구분</label>
                                <select x-model="forms.record.subType" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                                    <option value="full">가득(상한)</option>
                                    <option value="partial">부분주유</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">단가 (원/L)</label>
                                <input type="number" x-model="forms.record.unitPrice" @input="calculateVolume" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                            </div>
                        </div>
                         <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">주유량 (L)</label>
                                <input type="number" step="0.01" x-model="forms.record.volume" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                            </div>
                            <div x-show="forms.record.subType === 'full'">
                                <label class="block text-xs font-medium text-gray-400 mb-1">연료게이지 (%)</label>
                                <input type="number" x-model="forms.record.fuelGauge" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                            </div>
                        </div>
                    </div>

                    <!-- Type Specific Fields: Maintenance -->
                    <div x-show="detail.tab === 'maintenance'" class="space-y-4 border-t border-dark-700 pt-4">
                         <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">구분</label>
                                <select x-model="forms.record.subType" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                                    <option value="maintenance">정비</option>
                                    <option value="inspection">점검</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">정비 항목</label>
                                <input type="text" x-model="forms.record.item" placeholder="예: 엔진오일 교환" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                            </div>
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-400 mb-1">메모</label>
                             <textarea x-model="forms.record.memo" rows="2" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand"></textarea>
                        </div>
                    </div>

                    <!-- Type Specific Fields: Etc -->
                    <div x-show="detail.tab === 'etc'" class="space-y-4 border-t border-dark-700 pt-4">
                         <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">지출 항목</label>
                            <input type="text" x-model="forms.record.item" placeholder="예: 세차, 방향제" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-400 mb-1">메모</label>
                             <textarea x-model="forms.record.memo" rows="2" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand"></textarea>
                        </div>
                    </div>

                    <div class="pt-4 flex justify-end gap-2">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-dark-700">취소</button>
                        <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium bg-white text-black hover:bg-gray-200">기록 추가</button>
                    </div>
                </form>

                <!-- Modal: WebDAV -->
                <div x-show="modal.type === 'webdav-config'" class="space-y-4">
                     <!-- (Same WebDAV content) -->
                    <div class="p-3 bg-brand/10 border border-brand/20 rounded-md text-brand text-xs">
                        <i data-lucide="info" class="inline w-3 h-3 mr-1"></i> 현재 버전에서는 UI 시뮬레이션만 제공됩니다.
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">서버 주소</label>
                        <input type="text" placeholder="https://dav.example.com" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">아이디</label>
                            <input type="text" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">비밀번호</label>
                            <input type="password" class="w-full bg-dark-900 border border-dark-600 rounded-md px-3 py-2 text-white focus:outline-none focus:border-brand">
                        </div>
                    </div>
                    <div class="pt-4 flex justify-end gap-2">
                         <button type="button" @click="closeModal()" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-dark-700">취소</button>
                         <button type="button" @click="connectWebDAVSim()" class="px-4 py-2 rounded-md text-sm font-medium bg-brand hover:bg-brand-hover text-white">연결</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" 
                 class="px-4 py-2.5 rounded-full shadow-lg border text-sm font-medium flex items-center gap-2 pointer-events-auto"
                 :class="{
                    'bg-dark-800 border-brand text-white': toast.type === 'success',
                    'bg-red-900/90 border-red-700 text-white': toast.type === 'error',
                    'bg-dark-700 border-dark-600 text-gray-200': toast.type === 'info'
                 }">
                <i x-show="toast.type === 'success'" data-lucide="check-circle" class="w-4 h-4 text-brand"></i>
                <i x-show="toast.type === 'error'" data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script>
        // --- Backend Abstraction Layer ---
        const Backend = {
            DB_KEY: 'chagyebu_db',
            load() {
                const raw = localStorage.getItem(this.DB_KEY);
                return raw ? JSON.parse(raw) : null;
            },
            save(data) {
                localStorage.setItem(this.DB_KEY, JSON.stringify(data));
                return true;
            },
            initNew() {
                const initialData = {
                    config: { type: 'local', lastSync: null },
                    cars: [],
                    records: [] // { id, carId, type(refuel/maint/etc), date, amount, odometer, place ... }
                };
                this.save(initialData);
                return initialData;
            },
            clear() { return true; }
        };

        // --- Alpine App Logic ---
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                router: { current: 'onboarding' },
                db: null,
                
                // UI States
                modal: { active: false, type: null },
                detail: { carId: null, tab: 'info', isEditing: false, editBuffer: {} },
                
                // Forms & Filters
                forms: {
                    car: { number: '', maker: '', model: '', year: '', fuelType: '휘발유', totalDistance: '' },
                    record: {} // Dynamic based on type
                },
                filters: { dateStart: '', dateEnd: '', type: 'all', search: '' },
                
                toasts: [],

                init() {
                    this.$watch('router.current', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('modal.active', (val) => { if(val) this.$nextTick(() => lucide.createIcons()); });
                    this.$watch('detail.tab', () => this.$nextTick(() => lucide.createIcons()));

                    const existingData = Backend.load();
                    if (existingData) {
                        this.db = existingData;
                        this.router.current = 'car-list';
                        this.showToast('데이터베이스를 불러왔습니다.', 'success');
                    }
                    lucide.createIcons();
                },

                // --- Getters ---
                get activeCar() {
                    if (!this.db || !this.detail.carId) return null;
                    return this.db.cars.find(c => c.id === this.detail.carId) || null;
                },

                get filteredRecords() {
                    if (!this.db || !this.detail.carId) return [];
                    
                    // 1. Filter by Car & Tab Type
                    let records = this.db.records.filter(r => r.carId === this.detail.carId && r.type === this.detail.tab);
                    
                    // 2. Sort by Date Desc (Time strict: Date + created timestamp if same date)
                    records.sort((a, b) => new Date(b.date) - new Date(a.date));

                    // 3. Apply Filters
                    if (this.filters.dateStart) {
                        records = records.filter(r => r.date >= this.filters.dateStart);
                    }
                    if (this.filters.dateEnd) {
                        records = records.filter(r => r.date <= this.filters.dateEnd);
                    }
                    if (this.detail.tab === 'maintenance' && this.filters.type !== 'all') {
                        records = records.filter(r => r.subType === this.filters.type);
                    }
                    if (this.filters.search) {
                        const q = this.filters.search.toLowerCase();
                        records = records.filter(r => {
                            const searchable = [r.item, r.place, r.memo, r.title].join(' ').toLowerCase();
                            return searchable.includes(q);
                        });
                    }
                    return records;
                },

                get placeSuggestions() {
                    // Collect unique places from history for autocomplete
                    if(!this.db) return [];
                    const places = this.db.records.map(r => r.place).filter(p => p);
                    return [...new Set(places)];
                },

                // --- Actions ---
                createLocalDatabase() {
                    this.db = Backend.initNew();
                    this.router.current = 'car-list';
                    this.showToast('새 로컬 데이터베이스 생성됨', 'success');
                },

                openModal(type) {
                    this.modal.type = type;
                    this.modal.active = true;
                    
                    if (type === 'add-car') {
                        this.forms.car = { number: '', maker: '', model: '', year: new Date().getFullYear(), fuelType: '휘발유', totalDistance: '' };
                    } else if (type === 'add-record') {
                        // Init record form based on current tab and active car
                        const today = new Date().toISOString().slice(0, 10);
                        this.forms.record = {
                            date: today,
                            odometer: this.activeCar ? this.activeCar.totalDistance : 0,
                            amount: '',
                            place: '',
                            // Defaults per type
                            subType: this.detail.tab === 'refuel' ? 'full' : (this.detail.tab === 'maintenance' ? 'maintenance' : ''),
                            unitPrice: '', volume: '', fuelGauge: '', // Refuel
                            item: '', memo: '' // Maint/Etc
                        };
                    }
                },

                closeModal() {
                    this.modal.active = false;
                    setTimeout(() => { this.modal.type = null; }, 200);
                },

                submitAddCar() {
                    const newCar = {
                        id: crypto.randomUUID(),
                        ...this.forms.car,
                        grade: '', displacement: '',
                        totalDistance: Number(this.forms.car.totalDistance) || 0,
                        createdAt: new Date().toISOString()
                    };
                    this.db.cars.push(newCar);
                    this.autoSave();
                    this.closeModal();
                    this.showToast('차량이 추가되었습니다.', 'success');
                },

                submitAddRecord() {
                    const r = this.forms.record;
                    const newRecord = {
                        id: crypto.randomUUID(),
                        carId: this.detail.carId,
                        type: this.detail.tab, // refuel | maintenance | etc
                        date: r.date,
                        amount: Number(r.amount) || 0,
                        odometer: Number(r.odometer) || 0,
                        place: r.place,
                        
                        // Specifics
                        subType: r.subType, // full/partial OR maint/inspection
                        unitPrice: r.unitPrice ? Number(r.unitPrice) : null,
                        volume: r.volume ? Number(r.volume) : null,
                        fuelGauge: r.fuelGauge ? Number(r.fuelGauge) : null,
                        item: r.item,
                        memo: r.memo,
                        
                        createdAt: new Date().toISOString()
                    };

                    this.db.records.push(newRecord);
                    
                    // Update Car Odometer if greater
                    const car = this.db.cars.find(c => c.id === this.detail.carId);
                    if (car && newRecord.odometer > car.totalDistance) {
                        car.totalDistance = newRecord.odometer;
                    }

                    this.autoSave();
                    this.closeModal();
                    this.showToast('내역이 추가되었습니다.', 'success');
                },

                // --- Helper Logic ---
                calculateVolume() {
                    if (this.detail.tab === 'refuel') {
                        const amt = Number(this.forms.record.amount);
                        const price = Number(this.forms.record.unitPrice);
                        if (amt > 0 && price > 0) {
                            this.forms.record.volume = (amt / price).toFixed(2);
                        }
                    }
                },

                selectCar(carId) {
                    this.detail.carId = carId;
                    this.detail.tab = 'info';
                    this.detail.isEditing = false;
                    this.router.current = 'car-detail';
                },

                toggleEditInfo() {
                    if (this.detail.isEditing) {
                        this.detail.isEditing = false;
                    } else {
                        this.detail.editBuffer = JSON.parse(JSON.stringify(this.activeCar));
                        this.detail.isEditing = true;
                    }
                },

                saveCarInfo() {
                    const index = this.db.cars.findIndex(c => c.id === this.detail.carId);
                    if (index > -1) {
                        this.db.cars[index] = {
                            ...this.db.cars[index],
                            ...this.detail.editBuffer,
                            year: Number(this.detail.editBuffer.year),
                            displacement: Number(this.detail.editBuffer.displacement)
                        };
                        this.autoSave();
                        this.detail.isEditing = false;
                        this.showToast('차량 정보가 저장되었습니다.', 'success');
                    }
                },

                // --- Utilities ---
                autoSave() { if (this.db) Backend.save(this.db); },

                getModalTitle() {
                    if (this.modal.type === 'add-car') return '차량 추가';
                    if (this.modal.type === 'webdav-config') return 'WebDAV 설정';
                    if (this.modal.type === 'add-record') {
                        const map = { 'refuel': '주유 기록 추가', 'maintenance': '정비 기록 추가', 'etc': '기타 지출 추가' };
                        return map[this.detail.tab] || '기록 추가';
                    }
                    return '';
                },

                getSubTypeLabel(record) {
                    const map = {
                        'full': '가득', 'partial': '부분',
                        'maintenance': '정비', 'inspection': '점검'
                    };
                    return map[record.subType] || (this.detail.tab === 'etc' ? '지출' : '-');
                },

                formatDistance(km) { return new Intl.NumberFormat('ko-KR').format(km) + ' km'; },
                formatNumber(num) { return new Intl.NumberFormat('ko-KR').format(num); },
                
                showToast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type, visible: true });
                    setTimeout(() => {
                        const index = this.toasts.findIndex(t => t.id === id);
                        if (index > -1) this.toasts[index].visible = false;
                    }, 3000);
                    setTimeout(() => this.toasts = this.toasts.filter(t => t.id !== id), 3300);
                },

                // ... (Keep existing export/import/webdav functions) ...
                exportDB() {
                    if (!this.db) return;
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.db));
                    const node = document.createElement('a');
                    node.href = dataStr;
                    node.download = "chagyebu_backup_" + new Date().toISOString().slice(0,10) + ".json";
                    document.body.appendChild(node);
                    node.click();
                    node.remove();
                    this.showToast('백업 완료', 'success');
                },
                triggerImport() { document.getElementById('fileInput').click(); },
                handleFileImport(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (data.cars) {
                                this.db = data;
                                Backend.save(this.db);
                                this.router.current = 'car-list';
                                this.showToast('복원 완료', 'success');
                            }
                        } catch(err) { this.showToast('파일 오류', 'error'); }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                },
                connectWebDAVSim() {
                    this.closeModal();
                    this.showToast('WebDAV 연결됨 (Sim)', 'success');
                    if (!this.db) { this.db = Backend.initNew(); this.db.config.type = 'webdav'; }
                    this.router.current = 'car-list';
                },
                closeDatabase() {
                    this.db = null;
                    this.router.current = 'onboarding';
                    this.showToast('닫기 완료', 'info');
                }
            }));
        });
    </script>
</body>
</html>
