<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심플 차계부 (Car Logbook)</title>
    <link rel="stylesheet" href="https://unpkg.com/basecoat-ui/dist/basecoat.min.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
        }
        
        * {
            box-sizing: border-box;
            border-color: var(--border);
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; position: relative; min-height: 100vh;}

        /* Component Styles */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        .btn:hover { background-color: #f1f5f9; }
        .btn:active { transform: translateY(1px); }
        
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        
        .input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 0.25rem;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem;}
        .tab { padding: 0.5rem 0.75rem; cursor: pointer; border-radius: 8px; color: var(--text-sub); white-space: nowrap; font-size: 0.9rem; font-weight: 500; transition: all 0.2s;}
        .tab:hover { background-color: #f1f5f9; }
        .tab.active { background-color: var(--primary); color: white; font-weight: bold; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: modalPop 0.2s ease-out;
        }
        @keyframes modalPop {
            0% { transform: scale(0.98); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* List View */
        .log-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .log-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: background-color 0.2s;
        }
        .log-item:active { background-color: #f8fafc; }

        /* Maintenance Scroll */
        .maintenance-scroll {
            display: flex;
            overflow-x: auto;
            gap: 0.75rem;
            padding: 0.25rem 0 1rem 0;
            scroll-snap-type: x mandatory;
        }
        .maint-card {
            min-width: 240px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            flex-shrink: 0;
            scroll-snap-align: start;
            position: relative;
        }
        .progress-bar { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 0.75rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease-out; }

        /* Custom Select */
        .custom-select-wrapper { position: relative; }
        .custom-select-dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .custom-select-option {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }
        .custom-select-option:hover { background-color: #f8fafc; }
        .custom-select-option:last-child { border-bottom: none; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem; z-index: 1000;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.show { opacity: 1; }
        
        .unsaved-banner {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff7ed; border-top: 1px solid #fdba74;
            color: #9a3412; padding: 10px; text-align: center;
            display: flex; justify-content: center; gap: 10px;
            align-items: center; z-index: 90;
        }

        /* Add Button Row */
        .add-row-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            background: #f8fafc;
            color: var(--text-sub);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }
        .add-row-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #eff6ff;
        }
    </style>
</head>
<body>
    <div x-data="app" class="container">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 sticky top-0 bg-body/95 backdrop-blur z-30 py-2">
            <h1 class="font-bold text-xl flex items-center gap-2 text-blue-600 cursor-pointer" @click="route='home'">
                <i class="ph ph-car-profile text-2xl"></i> 
                <span>차계부</span>
            </h1>
            <div x-show="route !== 'home'">
                <button @click="goBack()" class="btn text-sm border-0 bg-transparent text-gray-500 hover:bg-gray-100">
                    <i class="ph ph-arrow-left text-lg"></i>
                </button>
            </div>
        </header>

        <!-- View: Home -->
        <div x-show="route === 'home'" class="flex flex-col gap-4 mt-10">
            <div class="card p-8 text-center">
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                        <i class="ph ph-garage text-3xl"></i>
                    </div>
                </div>
                <h2 class="font-bold text-2xl mb-2">환영합니다!</h2>
                <p class="mb-8 text-gray-500">차량 관리를 시작할 데이터베이스를 선택하세요.</p>
                <div class="flex flex-col gap-3">
                    <button @click="openDB('local')" class="btn btn-primary py-3 justify-center">
                        <i class="ph ph-device-mobile"></i> 내 기기에서 시작
                    </button>
                    <button @click="createDB()" class="btn text-red-500 py-3 justify-center border-red-200 hover:bg-red-50">
                        <i class="ph ph-trash"></i> 데이터 초기화
                    </button>
                </div>
            </div>
        </div>

        <!-- View: List -->
        <div x-show="route === 'list'" class="flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-lg">내 차량 목록</h2>
                <button @click="addVehicle()" class="btn btn-primary text-sm"><i class="ph ph-plus"></i> 추가</button>
            </div>

            <div class="flex flex-col gap-3">
                <template x-for="(car, index) in db.data.vehicles" :key="car.id">
                    <div class="card flex justify-between items-center cursor-pointer hover:border-blue-300 transition-colors" @click="selectVehicle(car)">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500">
                                <i class="ph ph-car text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight" x-text="car.info.number"></h3>
                                <p class="text-sm text-gray-500 mt-0.5" x-text="[car.info.maker, car.info.model].filter(Boolean).join(' ') || '정보 없음'"></p>
                            </div>
                        </div>
                        <button @click.stop="deleteVehicle(index)" class="text-gray-400 hover:text-red-500 p-2"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                </template>
            </div>
            
            <div x-show="db.data.vehicles.length === 0" class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                <i class="ph ph-car text-3xl mb-2 block opacity-50"></i>
                등록된 차량이 없습니다.
            </div>

            <div class="card p-4 mt-4 bg-gray-50 border-none">
                <div class="flex gap-2 justify-center">
                    <button @click="exportDB()" class="btn text-sm bg-white text-gray-600"><i class="ph ph-download-simple"></i> 백업</button>
                    <label class="btn text-sm bg-white text-gray-600 cursor-pointer">
                        <i class="ph ph-upload-simple"></i> 복원
                        <input type="file" class="hidden" @change="importDB">
                    </label>
                </div>
            </div>
        </div>

        <!-- View: Detail -->
        <div x-show="route === 'detail'" class="w-full pb-20">
            <!-- Tabs -->
            <div class="tabs sticky top-[50px] bg-body z-20">
                <div class="tab" :class="{ 'active': activeTab === 'info' }" @click="activeTab = 'info'">정보</div>
                <div class="tab" :class="{ 'active': activeTab === 'fuel' }" @click="activeTab = 'fuel'">주유</div>
                <div class="tab" :class="{ 'active': activeTab === 'maint' }" @click="activeTab = 'maint'">정비</div>
                <div class="tab" :class="{ 'active': activeTab === 'other' }" @click="activeTab = 'other'">기타</div>
            </div>

            <!-- Tab: Info -->
            <div x-show="activeTab === 'info'" class="card">
                <h3 class="font-bold mb-4 text-lg">차량 정보</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="label">차량번호</label><input type="text" x-model="currentVehicle.info.number" class="input"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label">제조사</label><input type="text" x-model="currentVehicle.info.maker" class="input"></div>
                        <div><label class="label">차종</label><input type="text" x-model="currentVehicle.info.model" class="input"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label">연식</label><input type="number" x-model="currentVehicle.info.year" class="input"></div>
                        <div><label class="label">배기량(cc)</label><input type="number" x-model="currentVehicle.info.cc" class="input"></div>
                    </div>
                    <div>
                        <label class="label">연료</label>
                        <select x-model="currentVehicle.info.fuel" class="input">
                            <option value="gasoline">휘발유</option>
                            <option value="diesel">경유</option>
                            <option value="lpg">LPG</option>
                            <option value="electric">전기</option>
                            <option value="hybrid">하이브리드</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Maintenance Timer Section (Only in Maint Tab) -->
            <div x-show="activeTab === 'maint'" class="mb-6">
                <div class="flex justify-between items-end mb-2 px-1">
                    <h4 class="font-bold text-gray-700">정비 타이머</h4>
                    <button @click="openAddRuleForm()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">
                        + 타이머 추가
                    </button>
                </div>
                <div class="maintenance-scroll">
                    <template x-for="(card, idx) in maintenanceCards" :key="idx">
                        <div class="maint-card shadow-sm border-l-4" :class="card.percent >= 90 ? 'border-l-red-500' : 'border-l-blue-500'">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-lg truncate pr-2" x-text="card.name"></span>
                                <div class="flex gap-1">
                                    <button @click="snoozeRule(card.originalIndex)" class="p-1 text-gray-400 hover:text-blue-500 rounded bg-gray-50" title="1000km 미루기">
                                        <i class="ph ph-moon"></i>
                                    </button>
                                    <button @click="deleteRule(card.originalIndex)" class="p-1 text-gray-400 hover:text-red-500 rounded bg-gray-50">
                                        <i class="ph ph-x"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between items-end mb-1">
                                <div class="text-sm text-gray-600">
                                    <span x-text="card.remainingKm > 0 ? card.remainingKm.toLocaleString() + 'km 남음' : Math.abs(card.remainingKm).toLocaleString() + 'km 지남'"></span>
                                </div>
                                <span class="text-xs font-bold px-1.5 py-0.5 rounded bg-red-100 text-red-600" x-show="card.percent >= 90">점검필요</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="'width: ' + Math.min(card.percent, 100) + '%'" :class="{'bg-red-500': card.percent >= 90}"></div>
                            </div>
                            <div class="text-xs text-gray-400 mt-2 text-right">
                                주기: <span x-text="card.interval.toLocaleString()"></span>km
                                <span x-show="card.deferred > 0" x-text="` (+${card.deferred.toLocaleString()}km 미룸)`"></span>
                            </div>
                        </div>
                    </template>
                    <!-- Empty State for Rules -->
                    <div x-show="maintenanceCards.length === 0" class="maint-card flex flex-col items-center justify-center text-gray-400 border-dashed">
                        <i class="ph ph-wrench text-2xl mb-1"></i>
                        <span class="text-sm">타이머를 추가해보세요</span>
                    </div>
                </div>
            </div>

            <!-- Filters & Search (Inline) -->
            <div x-show="activeTab !== 'info'" class="mb-4">
                <div class="flex gap-2 mb-2">
                    <div class="relative w-full">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" x-model="searchTerm" placeholder="검색" class="input pl-9 py-2 text-sm bg-white">
                    </div>
                    <button @click="toggleFilter = !toggleFilter" class="btn px-3 text-gray-500" :class="{'bg-blue-50 text-blue-600 border-blue-200': hasActiveFilters}">
                        <i class="ph ph-faders"></i>
                    </button>
                </div>
                
                <!-- Expanded Filters -->
                <div x-show="toggleFilter" class="card p-3 mb-2 bg-gray-50 border-gray-200" x-transition>
                    <div class="flex gap-2 mb-2">
                        <input type="date" x-model="filterDateStart" class="input text-sm bg-white">
                        <span class="self-center text-gray-400">~</span>
                        <input type="date" x-model="filterDateEnd" class="input text-sm bg-white">
                    </div>
                    <div x-show="activeTab === 'maint'" class="flex gap-4 items-center text-sm">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" value="all" x-model="filterType" class="accent-blue-600"> 전체</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" value="repair" x-model="filterType" class="accent-blue-600"> 정비</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" value="check" x-model="filterType" class="accent-blue-600"> 점검</label>
                    </div>
                </div>
            </div>

            <!-- Add Button Row (Top of List) -->
            <div x-show="activeTab !== 'info'">
                <button @click="openAddForm()" class="add-row-btn">
                    <i class="ph ph-plus-circle text-xl"></i>
                    <span x-text="getTabName() + ' 기록 추가하기'"></span>
                </button>
            </div>

            <!-- Log List (1 Column Layout) -->
            <div x-show="activeTab !== 'info'" class="log-list pb-20">
                <template x-for="log in paginatedLogs" :key="log.id">
                    <div class="log-item relative">
                        <!-- Row 1: Date & Cost -->
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-gray-800" x-text="log.date"></div>
                            <div class="font-bold text-blue-600" x-text="Number(log.cost).toLocaleString() + '원'"></div>
                        </div>

                        <!-- Row 2: Main Info (Item or Volume) -->
                        <div class="mb-2">
                             <div x-show="activeTab === 'fuel'" class="flex gap-2 text-sm text-gray-700">
                                <span class="bg-blue-50 text-blue-700 px-1.5 rounded text-xs self-center" x-text="log.fuelType === 'full' ? '가득' : '부분'"></span>
                                <span x-text="log.volume + 'L'"></span>
                                <span class="text-gray-400">|</span>
                                <span x-text="Number(log.pricePerUnit).toLocaleString() + '원/L'"></span>
                            </div>
                            <div x-show="activeTab === 'maint'" class="flex gap-2 items-center">
                                <span class="bg-gray-100 text-gray-600 px-1.5 rounded text-xs" x-text="log.maintType === 'repair' ? '정비' : '점검'"></span>
                                <span class="font-medium" x-text="log.item"></span>
                            </div>
                            <div x-show="activeTab === 'other'" class="font-medium" x-text="log.item"></div>
                        </div>

                        <!-- Row 3: Odo & Place -->
                        <div class="flex items-center text-sm text-gray-500 gap-2 bg-gray-50 p-2 rounded-lg">
                            <div class="flex items-center gap-1">
                                <i class="ph ph-gauge"></i>
                                <span x-text="Number(log.odo).toLocaleString() + 'km'"></span>
                            </div>
                            <span class="text-gray-300">|</span>
                            <div class="flex items-center gap-1 overflow-hidden">
                                <i class="ph ph-map-pin" x-show="log.place"></i>
                                <span class="truncate" x-text="log.place || '-'"></span>
                            </div>
                        </div>

                        <!-- Efficiency Badge -->
                        <div x-show="log.efficiency" class="absolute top-10 right-4 text-xs font-bold text-green-600 flex items-center gap-1 bg-green-50 px-2 py-0.5 rounded-full border border-green-100">
                            <i class="ph ph-trend-up"></i> <span x-text="log.efficiency"></span> km/L
                        </div>

                        <!-- Memo -->
                         <div x-show="log.memo" class="mt-2 text-xs text-gray-500 flex gap-1">
                            <i class="ph ph-note-pencil"></i> <span x-text="log.memo"></span>
                        </div>
                        
                        <!-- Delete Action -->
                        <button @click="removeLog(activeTab, log.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </template>
            </div>

            <!-- Pagination -->
            <div x-show="activeTab !== 'info' && currentLogs.length > itemsPerPage" class="flex justify-center gap-4 mt-6 pb-20 items-center">
                <button @click="page--" :disabled="page === 1" class="btn text-sm px-4">이전</button>
                <span class="text-sm font-bold text-gray-600" x-text="page + ' / ' + Math.ceil(currentLogs.length/itemsPerPage)"></span>
                <button @click="page++" :disabled="paginatedLogs.length < itemsPerPage" class="btn text-sm px-4">다음</button>
            </div>
        </div>

        <!-- MODAL: Add/Edit Log Form -->
        <div x-show="showAddForm" class="modal-overlay hidden" :class="{ 'hidden': !showAddForm }">
            <div class="modal-content" @click.away="closeAddForm()">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                    <h3 class="font-bold text-lg" x-text="getTabName() + ' 기록'"></h3>
                    <button @click="closeAddForm()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
                </div>
                
                <div class="p-5 flex flex-col gap-5">
                    <!-- Common: Date & Odo -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label">날짜</label>
                            <input type="date" x-model="logForm.date" class="input">
                        </div>
                        <div>
                            <label class="label">주행거리 (km)</label>
                            <input type="number" x-model="logForm.odo" class="input" placeholder="0">
                        </div>
                    </div>

                    <!-- Tab Specific Forms -->
                    <template x-if="activeTab === 'fuel'">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col gap-3">
                            <div class="flex gap-4 justify-center mb-1">
                                <label class="flex items-center gap-2 cursor-pointer text-sm font-semibold">
                                    <input type="radio" value="full" x-model="logForm.fuelType" class="accent-blue-600 w-4 h-4"> 가득(상한)
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer text-sm font-semibold">
                                    <input type="radio" value="part" x-model="logForm.fuelType" class="accent-blue-600 w-4 h-4"> 부분주유
                                </label>
                            </div>
                            <div>
                                <label class="label text-xs text-blue-800">총 결제금액</label>
                                <input type="number" x-model="logForm.cost" placeholder="0" class="input font-bold text-right text-lg border-blue-200 focus:border-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="label text-xs text-blue-800">단가 (원/L)</label>
                                    <input type="number" x-model="logForm.pricePerUnit" class="input text-right text-sm">
                                </div>
                                <div>
                                    <label class="label text-xs text-blue-800">주유량 (L)</label>
                                    <input type="number" x-model="logForm.volume" class="input text-right text-sm">
                                </div>
                            </div>
                        </div>
                    </template>

                    <template x-if="activeTab === 'maint'">
                        <div class="flex flex-col gap-3">
                            <div class="flex gap-2">
                                <select x-model="logForm.maintType" class="input w-28 font-bold text-sm">
                                    <option value="repair">정비</option>
                                    <option value="check">점검</option>
                                </select>
                                <input type="text" x-model="logForm.item" placeholder="항목 (예: 엔진오일)" class="input flex-1">
                            </div>
                            <div>
                                <label class="label">비용</label>
                                <input type="number" x-model="logForm.cost" placeholder="0" class="input text-right font-bold">
                            </div>
                        </div>
                    </template>

                    <template x-if="activeTab === 'other'">
                        <div class="flex flex-col gap-3">
                            <div>
                                <label class="label">지출 항목</label>
                                <input type="text" x-model="logForm.item" placeholder="예: 세차, 주차비" class="input">
                            </div>
                            <div>
                                <label class="label">비용</label>
                                <input type="number" x-model="logForm.cost" placeholder="0" class="input text-right font-bold">
                            </div>
                        </div>
                    </template>

                    <!-- Common: Place (Custom Select) & Memo -->
                    <div class="flex flex-col gap-3 border-t pt-4">
                        <div class="custom-select-wrapper" @click.outside="showPlaceDropdown = false">
                            <label class="label">장소</label>
                            <div class="relative">
                                <input type="text" x-model="logForm.place" @focus="showPlaceDropdown = true" @input="showPlaceDropdown = true" class="input pr-8" placeholder="장소 입력">
                                <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            
                            <!-- Custom Dropdown -->
                            <div x-show="showPlaceDropdown && filteredPlaces.length > 0" class="custom-select-dropdown">
                                <template x-for="p in filteredPlaces" :key="p">
                                    <div class="custom-select-option text-sm" @click="logForm.place = p; showPlaceDropdown = false" x-text="p"></div>
                                </template>
                            </div>
                        </div>
                        <div>
                            <label class="label">메모</label>
                            <input type="text" x-model="logForm.memo" class="input" placeholder="내용 입력">
                        </div>
                    </div>

                    <button @click="saveLog()" class="btn btn-primary w-full py-3 text-lg mt-2 shadow-lg shadow-blue-100">
                        저장하기
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL: Add Maintenance Rule Form -->
        <div x-show="showRuleForm" class="modal-overlay hidden" :class="{ 'hidden': !showRuleForm }">
             <div class="modal-content" @click.away="showRuleForm = false">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-lg">정비 알림 추가</h3>
                    <button @click="showRuleForm = false" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="p-5 flex flex-col gap-4">
                    <div>
                        <label class="label">정비 항목명</label>
                        <input type="text" x-model="ruleForm.name" placeholder="예: 미션오일" class="input">
                    </div>
                    <div>
                        <label class="label">교체 주기 (km)</label>
                        <input type="number" x-model="ruleForm.km" placeholder="예: 40000" class="input">
                    </div>
                    <button @click="addRule()" class="btn btn-primary w-full mt-2">추가하기</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="toast" x-text="toastMsg"></div>
        
        <!-- Unsaved Banner -->
        <div x-show="showUnsaved" class="unsaved-banner hidden" :class="{ 'hidden': !showUnsaved }">
            <i class="ph ph-warning"></i> 저장되지 않은 변경사항이 있습니다.
            <button @click="db.save()" class="btn text-xs bg-white border-orange-300">지금 저장</button>
        </div>

    </div>

    <script type="module">
        import Alpine from 'https://esm.sh/alpinejs';
        
        // --- Backend Abstraction ---
        class DataManager {
            constructor() {
                this.type = 'local';
                this.data = { vehicles: [] };
                this.isDirty = false;
            }

            init() {
                const saved = localStorage.getItem('carlog_db');
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                    } catch(e) { console.error("Data parse error", e); }
                }
            }

            reset() {
                this.data = { vehicles: [] };
                this.save();
            }

            importData(jsonString) {
                try {
                    this.data = JSON.parse(jsonString);
                    this.save();
                    return true;
                } catch (e) {
                    alert('잘못된 데이터 형식입니다.');
                    return false;
                }
            }

            exportData() {
                return JSON.stringify(this.data, null, 2);
            }

            save() {
                if (this.type === 'local') {
                    localStorage.setItem('carlog_db', JSON.stringify(this.data));
                    this.isDirty = false;
                } else {
                    this.isDirty = true;
                    // WebDAV logic stub
                }
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                route: 'home',
                db: new DataManager(),
                currentVehicle: null,
                activeTab: 'info',
                showUnsaved: false,
                toastMsg: '',
                
                // Form State
                showAddForm: false,
                showRuleForm: false,
                showPlaceDropdown: false,
                toggleFilter: false,
                logForm: {},
                ruleForm: { name: '', km: '' },
                
                // Filters
                searchTerm: '',
                filterDateStart: '',
                filterDateEnd: '',
                filterType: 'all',
                page: 1,
                itemsPerPage: 50, // Reduced for mobile scroll

                init() {
                    this.db.init();
                    this.$watch('db.data', () => {
                        this.db.save();
                        this.checkUnsaved();
                    });
                },

                checkUnsaved() {
                    this.showUnsaved = (this.db.type === 'webdav' && this.db.isDirty);
                },

                openDB(type) {
                    this.db.type = type;
                    if (type === 'webdav') {
                        const url = prompt("WebDAV URL:");
                        if(url) {
                            alert("WebDAV 데모 모드");
                            this.route = 'list';
                        }
                    } else {
                        this.route = 'list';
                    }
                },

                createDB() {
                    if(confirm("기존 데이터가 초기화됩니다.")) {
                        this.db.reset();
                        this.route = 'list';
                    }
                },

                goBack() {
                    if (this.route === 'detail') this.route = 'list';
                    else if (this.route === 'list') this.route = 'home';
                },

                addVehicle() {
                    const number = prompt("차량 번호 입력:");
                    if (!number) return;
                    
                    const newCar = {
                        id: Date.now(),
                        info: { 
                            number: number, maker: '', model: '', trim: '', year: '', fuel: 'gasoline', cc: '',
                            maintenanceRules: [ // Default Rules
                                { name: '엔진오일', km: 10000 },
                                { name: '타이어', km: 40000 },
                                { name: '에어컨필터', km: 10000 },
                                { name: '브레이크패드', km: 40000 }
                            ]
                        },
                        logs: { fuel: [], maint: [], other: [] }
                    };
                    this.db.data.vehicles.push(newCar);
                    this.db.save();
                },

                selectVehicle(car) {
                    this.currentVehicle = car;
                    // Migrate old data if rules missing
                    if (!this.currentVehicle.info.maintenanceRules) {
                        this.currentVehicle.info.maintenanceRules = [
                            { name: '엔진오일', km: 10000 },
                            { name: '타이어', km: 40000 },
                            { name: '에어컨필터', km: 10000 },
                            { name: '브레이크패드', km: 40000 }
                        ];
                    }
                    this.activeTab = 'info';
                    this.route = 'detail';
                    this.resetFilters();
                },

                deleteVehicle(index) {
                    if(confirm("정말 삭제하시겠습니까?")) {
                        this.db.data.vehicles.splice(index, 1);
                        this.db.save();
                    }
                },

                exportDB() {
                    const blob = new Blob([this.db.exportData()], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `carlog_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                },

                importDB(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if(this.db.importData(e.target.result)) this.showToast("데이터 복원 완료");
                    };
                    reader.readAsText(file);
                },

                // --- Log Logic ---
                get hasActiveFilters() {
                    return this.filterDateStart || this.filterDateEnd || (this.activeTab === 'maint' && this.filterType !== 'all');
                },

                get currentLogs() {
                    if (!this.currentVehicle) return [];
                    let logs = [];
                    if (this.activeTab === 'fuel') logs = this.currentVehicle.logs.fuel;
                    else if (this.activeTab === 'maint') logs = this.currentVehicle.logs.maint;
                    else if (this.activeTab === 'other') logs = this.currentVehicle.logs.other;
                    
                    return logs.filter(log => {
                        const dateMatch = (!this.filterDateStart || log.date >= this.filterDateStart) &&
                                          (!this.filterDateEnd || log.date <= this.filterDateEnd);
                        
                        let typeMatch = true;
                        if (this.activeTab === 'maint' && this.filterType !== 'all') {
                            typeMatch = log.type === this.filterType;
                        }

                        const searchTarget = [log.item, log.place, log.memo].join(' ').toLowerCase();
                        const searchMatch = !this.searchTerm || searchTarget.includes(this.searchTerm.toLowerCase());

                        return dateMatch && typeMatch && searchMatch;
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                },

                get paginatedLogs() {
                    const start = (this.page - 1) * this.itemsPerPage;
                    return this.currentLogs.slice(start, start + this.itemsPerPage);
                },

                // --- Form Handling ---
                openAddForm() {
                    const today = new Date().toISOString().slice(0, 10);
                    const maxOdo = this.getMaxOdo();
                    
                    this.logForm = {
                        id: Date.now(),
                        date: today,
                        odo: maxOdo || '',
                        place: '', memo: '', cost: '',
                        fuelType: 'full', pricePerUnit: '', volume: '',
                        maintType: 'repair', item: ''
                    };
                    this.showAddForm = true;
                },

                closeAddForm() {
                    this.showAddForm = false;
                },

                getTabName() {
                    if (this.activeTab === 'fuel') return '주유';
                    if (this.activeTab === 'maint') return '정비';
                    if (this.activeTab === 'other') return '지출';
                    return '';
                },

                saveLog() {
                    if (!this.logForm.date) return alert("날짜를 입력해주세요.");
                    
                    const tab = this.activeTab;
                    const log = { ...this.logForm, cost: Number(this.logForm.cost) || 0 };

                    if (tab === 'fuel') {
                        // Efficiency Calc
                        const prevFull = this.currentVehicle.logs.fuel
                            .filter(l => l.fuelType === 'full' && l.date < log.date)
                            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        
                        if (prevFull && log.fuelType === 'full' && log.volume > 0) {
                            const dist = log.odo - prevFull.odo;
                            if (dist > 0) {
                                log.efficiency = (dist / log.volume).toFixed(1);
                                log.distance = dist;
                            }
                        }
                        this.currentVehicle.logs.fuel.push(log);
                    } else if (tab === 'maint') {
                        if (!log.item) return alert("정비 항목을 입력해주세요.");
                        this.currentVehicle.logs.maint.push(log);
                    } else {
                        if (!log.item) return alert("지출 항목을 입력해주세요.");
                        this.currentVehicle.logs.other.push(log);
                    }

                    this.db.save();
                    this.closeAddForm();
                    this.showToast("저장되었습니다.");
                },

                removeLog(tab, id) {
                    if(!confirm("삭제하시겠습니까?")) return;
                    const target = this.currentVehicle.logs[tab];
                    this.currentVehicle.logs[tab] = target.filter(l => l.id !== id);
                    this.db.save();
                },

                // --- Maintenance Timer Logic ---
                get maintenanceCards() {
                    if (!this.currentVehicle) return [];
                    const rules = this.currentVehicle.info.maintenanceRules || [];
                    const currentOdo = this.getMaxOdo();

                    return rules.map((rule, index) => {
                        // Find last maintenance matching rule name
                        const lastMaint = this.currentVehicle.logs.maint
                            .filter(l => l.item && l.item.includes(rule.name))
                            .sort((a, b) => b.odo - a.odo)[0];

                        const lastOdo = lastMaint ? Number(lastMaint.odo) : 0;
                        const deferred = rule.deferred || 0;
                        const nextKm = lastOdo + Number(rule.km) + deferred;
                        const remaining = nextKm - currentOdo;
                        
                        let percent = 0;
                        if (currentOdo > lastOdo) {
                            percent = Math.min(((currentOdo - lastOdo) / (Number(rule.km) + deferred)) * 100, 100);
                        }
                        
                        return {
                            name: rule.name,
                            nextKm: nextKm,
                            remainingKm: remaining,
                            interval: rule.km,
                            deferred: deferred,
                            percent: Math.floor(percent),
                            originalIndex: index
                        };
                    }).sort((a, b) => b.percent - a.percent);
                },

                openAddRuleForm() {
                    this.ruleForm = { name: '', km: '' };
                    this.showRuleForm = true;
                },

                addRule() {
                    if(!this.ruleForm.name || !this.ruleForm.km) return alert("내용을 입력해주세요.");
                    this.currentVehicle.info.maintenanceRules.push({
                        name: this.ruleForm.name,
                        km: Number(this.ruleForm.km),
                        deferred: 0
                    });
                    this.db.save();
                    this.showRuleForm = false;
                    this.showToast("타이머가 추가되었습니다.");
                },

                deleteRule(index) {
                    if(confirm("이 알림을 삭제하시겠습니까?")) {
                        this.currentVehicle.info.maintenanceRules.splice(index, 1);
                        this.db.save();
                    }
                },

                snoozeRule(index) {
                    const rule = this.currentVehicle.info.maintenanceRules[index];
                    rule.deferred = (rule.deferred || 0) + 1000;
                    this.db.save();
                    this.showToast(`${rule.name} 알림을 1,000km 미뤘습니다.`);
                },

                getMaxOdo() {
                    if (!this.currentVehicle) return 0;
                    const allLogs = [
                        ...this.currentVehicle.logs.fuel,
                        ...this.currentVehicle.logs.maint,
                        ...this.currentVehicle.logs.other
                    ];
                    if (allLogs.length === 0) return 0;
                    return Math.max(...allLogs.map(l => Number(l.odo) || 0));
                },

                // --- Place Autocomplete Helpers ---
                get filteredPlaces() {
                    const input = (this.logForm.place || '').toLowerCase();
                    const allPlaces = this.placeSuggestions;
                    return allPlaces.filter(p => p.toLowerCase().includes(input));
                },

                get placeSuggestions() {
                    if (!this.currentVehicle) return [];
                    const places = new Set();
                    const add = (arr) => arr.forEach(x => { if(x.place) places.add(x.place) });
                    
                    add(this.currentVehicle.logs.fuel);
                    add(this.currentVehicle.logs.maint);
                    add(this.currentVehicle.logs.other);
                    
                    return Array.from(places).sort();
                },

                resetFilters() {
                    this.searchTerm = '';
                    this.filterDateStart = '';
                    this.filterDateEnd = '';
                    this.page = 1;
                    this.toggleFilter = false;
                },

                showToast(msg) {
                    this.toastMsg = msg;
                    const el = document.getElementById('toast');
                    el.classList.add('show');
                    setTimeout(() => el.classList.remove('show'), 3000);
                }
            }));
        });
		
		Alpine.start();
    </script>
</body>
</html>